<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BOMB BUSTERS</title>
<style>
:root {
  --bg:#ffffff; --panel:#f5f7fa; --line:#d0d7de; --muted:#6c757d; --text:#212529;
  --accent:#0d6efd; --danger:#dc3545;
}
* { box-sizing: border-box }
html,body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, sans-serif; }
.wrap { max-width: 1200px; margin: 0 auto; padding: 8px; }
.card { background: var(--panel); border:1px solid var(--line); border-radius: 12px; }
header { display:flex; justify-content:space-between; align-items:center; padding:8px 12px; border-bottom:1px solid var(--line) }
header h1 { font-size:18px; margin:0; font-weight:bold }
header .badge { background:#e9ecef; padding:4px 8px; border-radius:999px; font-size:12px; }

.layout { display:grid; grid-template-columns: 220px 1fr 220px; gap:8px; padding:8px; }
@media(max-width:800px){ .layout { grid-template-columns: 1fr; } }

.panel { background:var(--bg); border:1px solid var(--line); border-radius:8px; padding:8px; }
#join { display:grid; gap:8px }
#join .row { display:flex; gap:6px; flex-wrap:wrap }
input, select, button { border:1px solid var(--line); padding:8px; border-radius:8px; font-size:14px; }
button { background:var(--accent); color:#fff; cursor:pointer; border:none; }
button.secondary { background:#e9ecef; color:var(--text); }
button:disabled { opacity:.6; cursor:not-allowed }

.list h3 { font-size:14px; margin:4px 0; color:var(--muted); }
.pill { display:inline-flex; align-items:center; gap:4px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; margin:2px; font-size:12px; background:#f8f9fa }
.me { outline:2px solid var(--accent); }
.host { border-color:#ffb23f; }

.cards { display:flex; gap:4px; justify-content:center; }
.cardv { background:#fff; border:1px solid var(--line); border-radius:6px; display:flex; justify-content:center; align-items:center; font-weight:bold; }
.mine.face { background:#f1f8ff; }
.back { background:#dee2e6; }
.clickable { cursor:pointer }

@media all {
  .cards { flex-wrap:nowrap; }
  .cardv { flex:0 0 auto; }
}

.controls { display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-top:6px; }
.hint { font-size:11px; color:var(--muted) }
.ok { color:green }
.err { color:var(--danger) }
</style>
</head>
<body>
<div class="wrap card">
  <header>
    <h1>BOMB BUSTERS</h1>
    <div><span class="badge">v1.0</span></div>
  </header>
  <div class="layout">
    <section class="panel" id="left">
      <div id="join">
        <div class="row">
          <input id="name" placeholder="名前" autocomplete="off"/>
          <input id="room" placeholder="ルーム4桁" maxlength="4"/>
        </div>
        <div class="row">
          <select id="role"><option value="player">参加</option><option value="spectator">観戦</option></select>
          <button id="enter">入室</button>
          <button id="copy" class="secondary">リンク</button>
        </div>
      </div>
      <div class="controls">
        <button id="start" disabled>ゲーム開始</button>
        <span id="status" class="hint"></span>
      </div>
    </section>
    <section class="panel" id="center"><div id="table"></div></section>
    <aside class="panel list" id="right">
      <h3>参加者</h3><div id="players"></div>
      <h3>観戦</h3><div id="spectators"></div>
    </aside>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, set, get, update, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

const firebaseConfig = {
  apiKey: "PASTE_YOURS",
  authDomain: "chat-68c4c.firebaseapp.com",
  databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
  projectId: "chat-68c4c",
  storageBucket: "chat-68c4c.appspot.com",
  messagingSenderId: "PASTE_YOURS",
  appId: "PASTE_YOURS"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const nameEl = document.querySelector('#name');
const roomEl = document.querySelector('#room');
const roleEl = document.querySelector('#role');
const enterBtn = document.querySelector('#enter');
const startBtn = document.querySelector('#start');
const statusEl = document.querySelector('#status');
const joinPanel = document.querySelector('#join');

let me={name:"",room:"",role:"player"};
let host=null, gameStarted=false;

roomEl.addEventListener('input',()=>{ roomEl.value=roomEl.value.replace(/\D/g,'').slice(0,4); });
enterBtn.addEventListener('click', joinRoom);
startBtn.addEventListener('click', startGame);

async function joinRoom(){
  const name = nameEl.value.trim();
  const room = roomEl.value.trim();
  const role = roleEl.value;
  if(!name || !/^[0-9]{4}$/.test(room)) return alert('名前と4桁ルーム');

  const hostRef = ref(db,`rooms/${room}/host`);
  const snap = await get(hostRef);
  if(!snap.exists()) {
    await set(hostRef,name);
    host = name;
    startBtn.disabled = false; // 自分がホストなら即有効化
  } else {
    host = snap.val();
  }

  me={name,room,role};
  const playersRef = ref(db,`rooms/${room}/players/${name}`);
  await update(playersRef,{name,role,online:true,joinedAt:Date.now()});
  onDisconnect(playersRef).remove();
  statusEl.textContent=`入室: ${room}`;
  joinPanel.style.display='none';
  listenRoom();
}

function listenRoom(){
  const roomRef = ref(db,`rooms/${me.room}`);
  onValue(roomRef, snap=>{
    if(!snap.exists()) return;
    const data = snap.val();
    gameStarted = !!data.started;
    renderLists(data);
    renderTable(data);

    const myName = me.name.trim().toLowerCase();
    const hostName = (data.host||"").trim().toLowerCase();
    if(myName === hostName){
      startBtn.disabled = gameStarted;
    }
    if(gameStarted){
      document.querySelector('#left').style.display='none';
      document.querySelector('#right').style.display='none';
      if(me.role==='player' && !data.players[me.name]){
        me.role='spectator';
      }
    }
  });
}

function renderLists(data){
  const playersDiv=document.querySelector('#players');
  const specsDiv=document.querySelector('#spectators');
  playersDiv.innerHTML=''; specsDiv.innerHTML='';
  if(data.players){
    Object.values(data.players).forEach(p=>{
      const el=document.createElement('div');
      el.className='pill'+(p.name===me.name?' me':'')+(p.name===data.host?' host':'');
      el.textContent=p.name;
      (p.role==='player'?playersDiv:specsDiv).appendChild(el);
    });
  }
}

function renderTable(data){
  const table=document.querySelector('#table');
  table.innerHTML='';
  if(!data.players) return;
  const totalCards=24;
  const cardValues=Array.from({length:12},(_,i)=>i+1).flatMap(v=>[v,v]);
  Object.values(data.players).forEach(p=>{
    const seat=document.createElement('div');
    seat.innerHTML=`<div>${p.name}</div>`;
    const cardsDiv=document.createElement('div');
    cardsDiv.className='cards';
    const myCards=p.name===me.name;
    const cards = p.cards || [];
    const cardWidth = `calc((100vw - 32px)/${cards.length||1})`;
    cardsDiv.style.setProperty('gap','4px');
    cards.forEach(c=>{
      const cEl=document.createElement('div');
      cEl.className='cardv';
      cEl.style.width=cardWidth;
      cEl.style.height=`calc(${cardWidth} * 1.4)`;
      if(myCards || c.open){
        cEl.textContent=c.num;
        cEl.classList.add('mine','face');
      } else {
        cEl.classList.add('back','clickable');
        cEl.addEventListener('click',()=>openCard(p.name,c.num));
      }
      cardsDiv.appendChild(cEl);
    });
    seat.appendChild(cardsDiv);
    table.appendChild(seat);
  });
}

function startGame(){
  const roomPath=`rooms/${me.room}`;
  get(ref(db,`${roomPath}/players`)).then(snap=>{
    if(!snap.exists()) return;
    const players=Object.keys(snap.val());
    const deck=Array.from({length:12},(_,i)=>i+1).flatMap(v=>[v,v]).sort(()=>Math.random()-0.5);
    const per=Math.floor(deck.length/players.length);
    const updates={started:true};
    players.forEach((name,i)=>{
      const cards=deck.slice(i*per,(i+1)*per).map(num=>({num,open:false}));
      updates[`players/${name}/cards`]=cards;
    });
    update(ref(db,roomPath),updates);
  });
}

function openCard(playerName,num){
  const roomPath=`rooms/${me.room}`;
  get(ref(db,`${roomPath}/players/${playerName}/cards`)).then(snap=>{
    if(!snap.exists()) return;
    const cards=snap.val();
    const idx=cards.findIndex(c=>c.num===num && !c.open);
    if(idx>-1){ cards[idx].open=true; update(ref(db,`${roomPath}/players/${playerName}/cards`),cards); }
  });
}
</script>
</body>
</html>
