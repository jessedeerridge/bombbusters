<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>BOMB BUSTERS</title>
<style>
:root{
  /* サイズ指定（要件どおり） */
  --card-w:24px; --card-h:50px; --card-gap:3px;
  --char-w:40px; --char-h:60px;
  --item-w:50px; --item-h:70px;
  --di-w:70px;   --di-h:70px;
  --table-h:90px;
  --font-card:16px; --font-weight:bold;
  --alpha-h:18px;

  --bd:#ddd; --ink:#111; --muted:#666; --bg:#fff;
  --ink-inv:#fff; --ink-weak:#000;
  --token-eq:#ffd8a8;   /* 薄オレンジ（＝） */
  --token-neq:#cde9ff;  /* 水色（≠） */
  --token-x1:#ffd1e8;   /* ピンク（x1） */
}
*{box-sizing:border-box}
html,body{height:auto;overflow:auto;background:#fff;color:#111;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif}
button,input,select{font:inherit}
a{color:inherit}

.app{max-width:860px;margin:0 auto;padding:8px 10px 16px}

header.appbar{
  position:sticky;top:0;background:#fff;
  padding:10px 6px;border-bottom:1px solid #eee;z-index:20;
  display:flex;align-items:center;gap:10px;justify-content:space-between
}
.brand{font-weight:700;letter-spacing:.5px}
.small{font-size:12px;color:#666}

.roomcode{font-size:11px;color:#999}
.roomcode b{font-weight:700;color:#555}

.hstack{display:flex;gap:8px;align-items:center}
.vstack{display:flex;flex-direction:column;gap:8px}
.gap-4{gap:4px}
.gap-6{gap:6px}
.gap-10{gap:10px}

.card{
  border:1px solid var(--bd);border-radius:10px;background:#fff;
  padding:10px
}

.btn{border:1px solid #ccc;background:#fff;border-radius:8px;padding:6px 10px}
.btn.primary{background:#111;color:#fff;border-color:#111}
.btn.ghost{background:transparent;border-color:#ddd}
.btn.warn{background:#b00020;color:#fff;border-color:#b00020}
.btn.small{padding:4px 8px;font-size:12px;border-radius:6px}
.btn:disabled{opacity:.5;pointer-events:none}

.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* --- スクロールできるタブ（席・人数・ミッション） --- */
.tabstrip{
  display:flex;gap:6px;overflow-x:auto;overflow-y:hidden;
  -webkit-overflow-scrolling:touch;white-space:nowrap;
  padding-bottom:2px;border-bottom:1px dashed #eee
}
.tab{border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px;flex:0 0 auto;background:#fff}
.tab.active{background:#111;color:#fff;border-color:#111}
.tab.locked{opacity:.45;pointer-events:none}

/* ---- ロビー ---- */
.lists{display:flex;gap:10px}
.list{flex:1 1 0}
.list h4{margin:0 0 6px 0;font-size:13px;color:#666}
.list ul{margin:0;padding:0;list-style:none;display:flex;flex-wrap:wrap;gap:6px}
.chip{border:1px solid #ddd;border-radius:999px;padding:3px 8px;font-size:12px}

/* ---- ゲーム盤 ---- */
.tables{display:flex;flex-direction:column;gap:10px;margin-top:8px}
.table{
  position:relative;border:1px dashed #ddd;border-radius:10px;background:#fff;width:max-content;
  height:var(--table-h);padding:4px 6px;overflow:hidden
}
.t-header{height:12px;display:flex;align-items:center;gap:6px;font-size:11px;color:#666}
.t-header .tname{text-decoration:underline}
.t-header .pname{font-size:10px;color:#999}

.t-content{display:flex;gap:8px;align-items:flex-start;height:calc(100% - 12px)}
.char{width:var(--char-w);height:var(--char-h);border:1px solid #ccc;border-radius:6px;overflow:hidden;background:#f4f4f4;display:flex;align-items:center;justify-content:center}
.char img{width:100%;height:100%;object-fit:cover;display:block}
.char.blank{background:#fafafa}

.hand-wrap{flex:0 0 auto;overflow-x:auto;overflow-y:hidden;margin-top:-2px;padding-bottom:2px}
.hand{display:flex;gap:var(--card-gap)}
.cslot{width:var(--card-w)}
.cimg{
  width:var(--card-w);height:var(--card-h);border-radius:4px;border:1px solid #ccc;overflow:hidden;
  display:flex;align-items:center;justify-content:center;user-select:none
}
.cimg.face.self{background:#e5e5e5;color:#fff;font-weight:var(--font-weight);font-size:var(--font-card)}
.cimg.face.public{background:#000;color:#fff;font-weight:var(--font-weight);font-size:var(--font-card)}
.cimg.back{background:#fff url('codeback.png') center/cover no-repeat}

.cimg .num{margin-top:-2px}

/* 末尾画像帯（下詰め） */
.cimg.face .band{margin-top:auto;width:100%;height:14px;background:#000}
.cimg.face .band.red{background:url('redcode.png') center/cover no-repeat}
.cimg.face .band.yellow{background:url('yellowcode.png') center/cover no-repeat}
.cimg.face.self .band:not(.red):not(.yellow){background:url('codenumber.png') center/cover no-repeat}
.cimg.face.public .band:not(.red):not(.yellow){background:url('codenumber.png') center/cover no-repeat}

/* アルファベット／トークン（枠で囲む・厳密に揃える） */
.alpha-grid{margin-top:2px;height:var(--alpha-h)}
.alpha-cell{
  width:var(--card-w);min-height:var(--alpha-h);
  border:1px solid #ccc;border-radius:4px;padding:1px 0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;background:#fff
}
.alpha{font-size:10px;line-height:1;color:#333}
.token{min-width:14px;min-height:14px;border-radius:3px;padding:0 3px;line-height:14px;font-size:11px;border:1px solid rgba(0,0,0,.08)}
.token.equal{background:var(--token-eq);color:#000}
.token.noteq{background:var(--token-neq);color:#000}
.token.x1{background:var(--token-x1);color:#000}
.token.black{background:#000;color:#fff;border:1px solid #111}

/* トークン・ミニメニュー */
.pop{
  position:absolute;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.08);
  padding:6px;display:flex;gap:6px;z-index:40
}
.pop .opt{border:1px solid #ddd;border-radius:6px;padding:4px 6px;font-size:12px;background:#fff}
.pop .opt.eq{background:var(--token-eq)}
.pop .opt.neq{background:var(--token-neq)}
.pop .opt.x1t{background:var(--token-x1)}

/* 右上：アイテム＋DI（待機画面では非表示） */
.topbar{display:flex;align-items:center;justify-content:space-between;margin:8px 0 0}
.items{display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.item{
  width:var(--item-w);height:var(--item-h);border:1px solid #ccc;border-radius:6px;overflow:hidden;background:#fff;flex:0 0 auto;position:relative
}
.item img{width:100%;height:100%;object-fit:cover;display:block}
.item.used::after{content:"";position:absolute;inset:0;background:#fff url('itemback.jpg') center/cover no-repeat}

.di{width:var(--di-w);height:var(--di-h);border:1px solid #ccc;border-radius:6px;overflow:hidden;flex:0 0 auto}
.di img{width:100%;height:100%;object-fit:cover;display:block}

/* 右下：設定 */
.fab{
  position:fixed;right:12px;bottom:14px;z-index:50
}
.menu{position:absolute;right:0;bottom:40px;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.1);padding:8px 10px;min-width:220px}
.menu h5{margin:4px 0 8px 0;font-size:12px;color:#666}
.menu .row{justify-content:flex-start}

/* ミッション（画面下までスクロールで見える） */
footer#missionBar{position:static;background:#fff;border-top:1px solid #eee;padding:10px 8px;margin-top:14px}
.mission-body{font-size:13px;color:#444}
.mission-body b{font-weight:700}

/* 参加/観戦パネル */
.join{display:flex;gap:6px;align-items:center}
.input{border:1px solid #ccc;border-radius:8px;padding:6px 10px;min-width:140px}

/* 目立たない小リンク */
a.tiny{font-size:11px;color:#888;text-decoration:underline}
.hide{display:none!important}

/* スマホ最適：テーブルは下に縦並び、全タブは横スクロール */
@media (max-width:640px){
  .lists{flex-direction:column}
}
</style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="brand">BOMB BUSTERS</div>
    <div class="roomcode" id="roomCodeBox" aria-live="polite"></div>
  </header>

  <!-- ロビー／参加画面 -->
  <section id="lobby" class="card vstack">
    <div class="join">
      <input id="roomInput" class="input" placeholder="ルームコード" />
      <button id="btnJoinPlay" class="btn">参加</button>
      <button id="btnJoinWatch" class="btn ghost">観戦</button>
    </div>

    <div class="row">
      <div class="hstack">
        <button id="btnStart" class="btn primary" disabled>爆弾を解除！</button>
        <span class="small">（ホストのみ）</span>
      </div>
      <a id="leaveLobby" class="tiny" href="javascript:void 0">退出</a>
    </div>

    <!-- 人数＆ミッションを同時に選ぶ：横スクロールタブ -->
    <div class="vstack">
      <div class="small">プレイ人数</div>
      <div id="playersTabs" class="tabstrip" role="tablist" aria-label="players"></div>
    </div>
    <div class="vstack">
      <div class="small">ミッション</div>
      <div id="missionTabs" class="tabstrip" role="tablist" aria-label="missions"></div>
    </div>

    <div class="lists">
      <div class="list">
        <h4>参加者</h4>
        <ul id="ulPlayers"></ul>
      </div>
      <div class="list">
        <h4>観戦者</h4>
        <ul id="ulWatchers"></ul>
      </div>
    </div>
  </section>

  <!-- ゲーム画面 -->
  <section id="board" class="card vstack hide">
    <div class="topbar">
      <div id="itemsBar" class="items"></div>
      <div class="hstack">
        <div id="diBox" class="di hide"><img alt=""></div>
      </div>
    </div>

    <div id="tables" class="tables"></div>
  </section>

  <!-- ミッション（下へスクロールで見える） -->
  <footer id="missionBar" class="card">
    <div class="row">
      <div class="small">ミッション</div>
      <div id="chosenMission" class="small" style="color:#999"></div>
    </div>
    <div id="missionText" class="mission-body"></div>
  </footer>

  <!-- 右下の設定 -->
  <div class="fab">
    <button id="btnGear" class="btn">⚙️</button>
    <div id="gearMenu" class="menu hide">
      <h5>席</h5>
      <div id="seatTabs" class="tabstrip"></div>
      <div class="row">
        <button id="btnSit" class="btn small">席に座る</button>
        <button id="btnStand" class="btn small ghost">席を立つ</button>
      </div>
      <h5>部屋</h5>
      <div class="row">
        <button id="btnRestart" class="btn small">やり直し</button>
        <button id="btnLeave" class="btn small">退出</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK (Modular CDN) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getDatabase, ref, onValue, set, update, push, remove, serverTimestamp,
  onDisconnect, get, child, runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

/* ===== Firebase 初期化 ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBpSx_lEcg1j9ExMJsVl5lBqAxOCfmFmSnI",
  authDomain: "chat-68c4c.firebaseapp.com",
  databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
  projectId: "chat-68c4c",
  storageBucket: "chat-68c4c.appspot.com",
  messagingSenderId: "172284325975",
  appId: "1:172284325975:web:6f9bdd77e822c0ea39dd92"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ====== 便利関数 ====== */
const $ = s => document.querySelector(s);
const el = (t, cls) => { const e = document.createElement(t); if(cls) e.className=cls; return e; };

function randHira3(){
  const hira="あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん";
  const pick=()=>hira[Math.floor(Math.random()*hira.length)];
  return pick()+pick()+pick();
}
function lettersFor(n){ // a..z -> enough
  const base="abcdefghijklmnopqrstuvwxyz";
  return Array.from({length:n},(_,i)=>base[i]||('?'));
}
function pad(n){return String(n).padStart(2,'0')}

/* ====== 状態 ====== */
let my = { id: null, name: null, role:"watch", roomId:null, isHost:false, seated:false, seatIndex:null, connId:null };
let room = null;           // ルームスナップショット
let game = null;           // ゲーム状態
let itemsState = {};       // 自分に配られたアイテム使用状態
let activeTokenPowers = {eq:false, neq:false, x1:false}; // ＝ / ≠ / x1 使用可否

/* ====== UI 構築：ロビーの人数/ミッションタブ ====== */
const playersTabs = $("#playersTabs");
const missionTabs = $("#missionTabs");
for(let n=2;n<=10;n++){ // 2〜10
  const t=el('button','tab'); t.textContent=n; t.dataset.val=n; playersTabs.appendChild(t);
}
for(let m=1;m<=10;m++){
  const t=el('button','tab'); t.textContent="#"+m; t.dataset.val=m; missionTabs.appendChild(t);
}
let chosenPlayers = 2, chosenMission = 1;
playersTabs.addEventListener('click',e=>{
  if(!e.target.classList.contains('tab'))return;
  chosenPlayers = +e.target.dataset.val;
  [...playersTabs.children].forEach(x=>x.classList.toggle('active', x===e.target));
});
missionTabs.addEventListener('click',e=>{
  if(!e.target.classList.contains('tab'))return;
  chosenMission = +e.target.dataset.val;
  [...missionTabs.children].forEach(x=>x.classList.toggle('active', x===e.target));
});
playersTabs.firstElementChild.classList.add('active');
missionTabs.firstElementChild.classList.add('active');

/* ====== 参加/観戦 ====== */
const roomCodeBox=$("#roomCodeBox");
const ulPlayers=$("#ulPlayers"), ulWatchers=$("#ulWatchers");
const btnStart=$("#btnStart");
$("#btnJoinPlay").onclick = ()=> join("play");
$("#btnJoinWatch").onclick= ()=> join("watch");
$("#leaveLobby").onclick= async ()=>{
  if(!my.roomId) return;
  await leaveRoom();
  location.reload();
};

async function join(role){
  const rid = ($("#roomInput").value||"").trim().toLowerCase();
  if(!rid){ alert("ルームコードを入力してください"); return; }
  my.roomId = rid;
  my.name = randHira3();
  my.role = role;
  my.id = crypto.randomUUID();
  my.connId = crypto.randomUUID();

  // ルーム初期ノード
  const rRef = ref(db, `rooms/${rid}`);
  const snap = await get(rRef);
  const exists = snap.exists();

  // 参加者/観戦者配列に自分を登録
  const listKey = role==="play" ? "players" : "watchers";
  await update(rRef, {
    createdAt: snap.exists() ? (snap.val().createdAt||serverTimestamp()) : serverTimestamp(),
    [listKey+`/${my.id}`]: { id:my.id, name:my.name, seated:false, seatIndex:null },
  });

  // ホストは最初の作成者
  my.isHost = !exists;

  // プレゼンス
  const pRef = ref(db, `rooms/${rid}/presence/${my.connId}`);
  await set(pRef, { uid: my.id, role: my.role, ts: serverTimestamp() });
  onDisconnect(pRef).remove();

  // 「退出」で自分を消す（ボタン／ページ遷移）
  window.addEventListener('beforeunload',()=>{ navigator.sendBeacon?.('', new Blob()); });

  // ロビー表示開始
  setupLobbyWatches();
  roomCodeBox.innerHTML = `ROOM <b>${rid}</b>`;
}

/* ロビーの監視（参加/観戦リスト、ホスト権限、ジャニター） */
function setupLobbyWatches(){
  const rRef = ref(db, `rooms/${my.roomId}`);
  onValue(rRef, snap=>{
    room = snap.val() || {};
    // 参加者/観戦者
    renderChips(ulPlayers, room.players);
    renderChips(ulWatchers, room.watchers);
    // ホストボタン
    btnStart.disabled = !my.isHost;
    // ジャニター：presence が空なら部屋ごと削除
    const hasPresence = room?.presence && Object.keys(room.presence).length>0;
    if(!hasPresence){
      // ルーム内に誰もいない場合、見つけたクライアントが掃除
      // （全員完全遮断時は、次回アプリを開いた誰かが掃除する）
      // 削除対象の安全確認（players と watchers が空）
      const hasMembers = (room.players && Object.keys(room.players).length) || (room.watchers && Object.keys(room.watchers).length);
      if(!hasMembers){ remove(ref(db, `rooms/${my.roomId}`)); }
    }
  });

  // スタート：人数と同時にミッション決定
  btnStart.onclick = async ()=>{
    if(!my.isHost) return;
    await startGame(chosenPlayers, chosenMission);
  };
}

function renderChips(root, map){
  root.innerHTML="";
  if(!map) return;
  Object.values(map).forEach(u=>{
    const li=el('li'); const c=el('div','chip'); c.textContent=u.name; li.appendChild(c); root.appendChild(li);
  });
}

/* ====== ゲーム開始 ====== */
async function startGame(nPlayers, missionNo){
  const rid = my.roomId;
  // テーブル＝人数ぶん生成（縦に並べる）
  const tables = Array.from({length:nPlayers}, (_,i)=>({
    index:i, playerId:null, playerName:null, hand:[], revealed:{}, alphaTokens:{}, character:null
  }));

  // デッキ生成（1〜12が4枚ずつ = 48）
  const deck=[];
  for(let v=1; v<=12; v++){ for(let k=0;k<4;k++) deck.push(v); }
  shuffle(deck);

  // 均等配布（余りなく順番に配る）＆各手札は昇順に保存
  const hands = tables.map(()=>[]);
  let idx=0;
  while(idx<deck.length){ for(let t=0;t<nPlayers && idx<deck.length;t++){ hands[t].push(deck[idx++]); } }
  hands.forEach(h=>h.sort((a,b)=>a-b));
  hands.forEach((h,i)=>tables[i].hand=h);

  // 隊長を1テーブルだけ（非表示）— 隊長テーブルはキャラ member(5).jpg
  const leader = Math.floor(Math.random()*nPlayers);

  // キャラカード：着席前はブランク（着席したら配布）
  const characters = [];
  const pool=[1,2,3,4]; shuffle(pool);
  for(let i=0;i<nPlayers;i++){
    characters[i] = (i===leader) ? 5 : pool.pop();
  }

  const rRef = ref(db, `rooms/${rid}`);
  // DI 初期画像
  const diName = `di${nPlayers}.png`;

  // ルームへ反映
  await update(rRef, {
    state:"playing",
    chosenPlayers:nPlayers,
    chosenMission:missionNo,
    di: { index:nPlayers, file: diName },
    tables: tables.reduce((acc,t,i)=>{ acc[i]={...t, character:`member (${characters[i]}).jpg`}; return acc; }, {}),
    items: {},                      // 配布時に埋める：今回は未指定なので空
    itemsUsedBy:{},                 // 誰が何を使用中かのフラグ
    missionDetail: missionDetailText(missionNo),
    lastUpdate: serverTimestamp()
  });

  // 盤面の監視を開始
  beginBoard();
}

/* ====== ボード描画とバインド ====== */
function beginBoard(){
  $("#lobby").classList.add('hide');
  $("#board").classList.remove('hide');

  // 盤全体
  onValue(ref(db, `rooms/${my.roomId}`), snap=>{
    game = snap.val() || {};
    // 上部：アイテム＆DI（待機画面では非表示—stateで分岐）
    renderItems(game.items || {});
    renderDI(game.di || null);
    renderTables(game.tables || {});
    // ミッション欄
    $("#chosenMission").textContent = game.chosenMission ? `#${game.chosenMission}` : "";
    $("#missionText").innerHTML = game.missionDetail || "";
  });

  // ギア
  $("#btnGear").onclick = ()=> $("#gearMenu").classList.toggle('hide');

  // 席 UI タブ（スクロール可能）
  onValue(ref(db, `rooms/${my.roomId}/tables`), snap=>{
    const tables = snap.val()||{};
    const seatTabs = $("#seatTabs"); seatTabs.innerHTML="";
    Object.keys(tables).forEach(i=>{
      const t=el('button','tab'); t.textContent=`テーブル ${+i+1}`; t.dataset.idx=i;
      if(game?.tables?.[i]?.playerId && game.tables[i].playerId!==my.id) t.classList.add('locked');
      if(my.seated && String(my.seatIndex)===String(i)) t.classList.add('active');
      seatTabs.appendChild(t);
    });
    seatTabs.onclick = (e)=>{
      if(!e.target.classList.contains('tab')) return;
      [...seatTabs.children].forEach(x=>x.classList.remove('active'));
      e.target.classList.add('active');
      seatTabs.dataset.sel = e.target.dataset.idx;
    };
  });

  // 席に座る／立つ（着席中は「席に座る」を無効）
  $("#btnSit").onclick = async ()=>{
    if(my.seated) return;
    const idx = +($("#seatTabs").dataset.sel || 0);
    const tRef = ref(db, `rooms/${my.roomId}/tables/${idx}`);
    const snap = await get(tRef); const t = snap.val();
    if(t.playerId && t.playerId!==my.id){ alert("そのテーブルは使用中です"); return; }

    // 着席
    await update(tRef, { playerId:my.id, playerName:my.name });
    await update(ref(db, `rooms/${my.roomId}/${my.role==="play"?"players":"watchers"}/${my.id}`), { seated:true, seatIndex:idx });
    my.seated=true; my.seatIndex=idx;

    // キャラクターカード可視化（ブランク→画像）
    // 何もしなくても描画側が t.character を表示します

    // 自分のアイテムUIなど更新
    $("#btnSit").disabled=true; $("#btnStand").disabled=false;
  };
  $("#btnStand").onclick = async ()=>{
    if(!my.seated) return;
    const idx = my.seatIndex;
    await update(ref(db, `rooms/${my.roomId}/tables/${idx}`), { playerId:null, playerName:null });
    await update(ref(db, `rooms/${my.roomId}/${my.role==="play"?"players":"watchers"}/${my.id}`), { seated:false, seatIndex:null });
    my.seated=false; my.seatIndex=null;
    $("#btnSit").disabled=false; $("#btnStand").disabled=true;
  };

  // やり直し（ホストのみ：確認小ボタン→キャンセル大ボタンの仕様はUIで再現済み）
  $("#btnRestart").onclick = async ()=>{
    if(!my.isHost) return;
    if(!confirm("やり直しますか？")) return;
    // 参加者は維持しつつ、盤面のみ初期化（ロビーに戻し、テーブルもクリア）
    await update(ref(db, `rooms/${my.roomId}`), {
      state:"lobby", tables:null, items:null, itemsUsedBy:null, di:null, chosenPlayers:null, chosenMission:null,
      missionDetail:null, lastUpdate:serverTimestamp()
    });
    location.reload();
  };

  // 退出（自身の参加/観戦ノード削除 → presence 削除 → 必要ならルームもクリーンアップ）
  $("#btnLeave").onclick = async ()=>{ await leaveRoom(); location.reload(); };
}

async function leaveRoom(){
  const rid=my.roomId; if(!rid) return;
  // 席を空に
  if(my.seated && my.seatIndex!=null){
    const tRef=ref(db, `rooms/${rid}/tables/${my.seatIndex}`);
    const t= (await get(tRef)).val();
    if(t?.playerId===my.id){ await update(tRef,{playerId:null,playerName:null}); }
  }
  // 自分のユーザノード削除
  const roleKey = my.role==="play"?"players":"watchers";
  await remove(ref(db, `rooms/${rid}/${roleKey}/${my.id}`)).catch(()=>{});
  // presence 自動削除（onDisconnect だけでもOKだが明示的にも）
  if(my.connId) await remove(ref(db, `rooms/${rid}/presence/${my.connId}`)).catch(()=>{});
  // 誰もいなければルーム削除
  const r = (await get(ref(db, `rooms/${rid}`))).val();
  const hasPresence = r?.presence && Object.keys(r.presence).length>0;
  const hasMembers = (r?.players && Object.keys(r.players).length) || (r?.watchers && Object.keys(r.watchers).length);
  if(!hasPresence && !hasMembers){ await remove(ref(db, `rooms/${rid}`)); }
}

/* ====== テーブル描画 ====== */
function renderTables(tables){
  const cont = $("#tables"); cont.innerHTML="";
  const tkeys = Object.keys(tables).sort((a,b)=>+a-+b);
  tkeys.forEach(k=>{
    const t = tables[k];
    const wrap = el('div','table');

    // ヘッダ（左に番号の下線、左上に小さくプレイヤー名）
    const header = el('div','t-header');
    const tname = el('div','tname'); tname.textContent = String(+k+1);
    const pname = el('div','pname'); pname.textContent = t.playerName ? t.playerName : "";
    header.append(tname, pname);

    // キャラクター（着席前はブランク）
    const content = el('div','t-content');
    const c = el('div','char ' + (t.playerId? '' : 'blank'));
    if(t.playerId){
      const img = new Image();
      img.alt="";
      img.src = t._flipped ? 'battery.jpg' : t.character; // flipped 状態は簡易保存でもOK
      c.appendChild(img);
      c.onclick = ()=>{
        // 誰でも裏表トグルできる仕様
        const nv = !t._flipped;
        update(ref(db, `rooms/${my.roomId}/tables/${k}`), {_flipped:nv});
      };
    }
    content.appendChild(header);
    content.appendChild(c);

    // 手札（常に昇順。全員から同じ順に見える。自分だけ表：薄灰。公開カードは黒。未公開は裏面）
    const hw = el('div','hand-wrap');
    const hand = el('div','hand');
    const H = Array.isArray(t.hand)? t.hand : [];
    const letters = lettersFor(H.length);
    H.forEach((num, i)=>{
      const slot = el('div','cslot');
      const img = el('div','cimg');  // 状態で class を付与
      // 自分のカードは face.self、公開は face.public、その他は back
      const isMine = t.playerId===my.id;
      const isRevealed = t.revealed && t.revealed[i];
      if(isRevealed) img.classList.add('face','public');
      else if(isMine) img.classList.add('face','self');
      else img.classList.add('back');

      // 数字（face時のみ表示）
      if(isRevealed || isMine){
        const numBox = el('div','num'); numBox.textContent = (num%1===0)? num : num.toString();
        img.appendChild(numBox);
        const band = el('div','band');
        if(String(num).endsWith('.5')) band.classList.add('red');
        else if(String(num).endsWith('.1')) band.classList.add('yellow');
        img.appendChild(band);
      }

      // クリック：自分のカードだけトグル（公開↔非公開）
      img.onclick = ()=>{
        if(!isMine) return; // 自分のみ
        const cur = !!(t.revealed && t.revealed[i]);
        update(ref(db, `rooms/${my.roomId}/tables/${k}/revealed`), { [i]: !cur });
      };

      slot.appendChild(img);

      // アルファ＋トークン（枠で囲む／黒地白文字 for 1..12）
      const ag = el('div','alpha-grid');
      const ac = el('div','alpha-cell'); ac.dataset.key=i;
      const a = el('div','alpha'); a.textContent = letters[i] || '?';
      ac.appendChild(a);
      // 既存トークン表示
      const toks = (t.alphaTokens && t.alphaTokens[i]) || [];
      toks.forEach(tv=>{
        const tk = el('div','token ' + (tv.type||''));
        tk.textContent = tv.type ? (tv.type==='equal'?'=': tv.type==='noteq'?'≠': tv.type==='x1'?'x1': tv.value) : (tv.value);
        if(!tv.type){ tk.classList.add('black'); }
        ac.appendChild(tk);
      });
      ac.onclick = (ev)=>{
        // ミニメニュー
        showTokenMenu(ev.currentTarget, k, i);
      };

      ag.appendChild(ac);
      slot.appendChild(ag);
      hand.appendChild(slot);
    });
    hw.appendChild(hand);
    content.appendChild(hw);

    wrap.appendChild(content);
    $("#tables").appendChild(wrap);
  });
}

function showTokenMenu(target, tableKey, cardIdx){
  // 位置
  document.querySelectorAll('.pop').forEach(p=>p.remove());
  const pop = el('div','pop');
  const r = target.getBoundingClientRect();
  pop.style.left = (r.left + window.scrollX) + "px";
  pop.style.top  = (r.top  + window.scrollY - 38) + "px";

  // =, ≠, x1（使用フラグで有効化）
  const eq = el('button','opt eq'); eq.textContent='＝'; eq.disabled=!activeTokenPowers.eq;
  const neq= el('button','opt neq'); neq.textContent='≠'; neq.disabled=!activeTokenPowers.neq;
  const x1t= el('button','opt x1t'); x1t.textContent='x1'; x1t.disabled=!activeTokenPowers.x1;

  const nums = Array.from({length:12},(_,i)=>i+1);
  const addTok = async (tok)=>{
    const base=`rooms/${my.roomId}/tables/${tableKey}/alphaTokens/${cardIdx}`;
    const arr = (await get(ref(db, base))).val() || [];
    arr.push(tok);
    await set(ref(db, base), arr);
    document.querySelectorAll('.pop').forEach(p=>p.remove());
  };
  eq.onclick = ()=> addTok({type:'equal'});
  neq.onclick=()=> addTok({type:'noteq'});
  x1t.onclick=()=> addTok({type:'x1'});

  pop.append(eq,neq,x1t);
  nums.forEach(n=>{
    const b=el('button','opt'); b.textContent=n;
    b.onclick = ()=> addTok({value:n});
    pop.appendChild(b);
  });
  document.body.appendChild(pop);
  const closer=(e)=>{ if(!pop.contains(e.target)) { pop.remove(); document.removeEventListener('mousedown', closer); } };
  setTimeout(()=>document.addEventListener('mousedown', closer),0);
}

/* ====== アイテム・DI ====== */
function renderItems(itemsMap){
  const bar=$("#itemsBar"); bar.innerHTML="";
  // 要件：待機画面には表示しない → state=playing のときだけ root から呼ばれている
  // （state 判定は beginBoard の呼び出し側で担保）
  // 配布されたカード（数字のみ表示＝画像ファイルで表示）
  Object.keys(itemsMap||{}).forEach(id=>{
    const item = itemsMap[id];
    const box = el('div','item' + (item.used?' used':'')); // used は裏表示（itemback.jpg）
    const img = new Image(); img.alt="";
    img.src = item.file; box.appendChild(img);
    box.onclick = (ev)=>{
      // タブ「使用する／表にする」：タップ時に小メニュー
      const pop = el('div','pop');
      const r = ev.currentTarget.getBoundingClientRect();
      pop.style.left = (r.left + window.scrollX) + "px";
      pop.style.top  = (r.top  + window.scrollY - 40) + "px";
      const useBtn = el('button','opt'); useBtn.textContent = item.used ? "表にする" : "使用する";
      useBtn.onclick = async ()=>{
        // 使用で → 使用中フラグを立て、対応パワーをON（＝／≠／x1）
        const used = !item.used;
        await update(ref(db, `rooms/${my.roomId}/items/${id}`), { used });
        // パワー付与（簡易：ファイル名で判定）
        if(item.file==="item (13).jpg"){ activeTokenPowers.eq = used; }
        if(item.file==="item (13).jpg" && id==="12"){ /* 仕様12も(13)画像指定なので片方の例外処理が必要ならここで */ }
        if(item.file==="item (9).jpg"){ activeTokenPowers.x1 = used; }
        if(item.file==="item (13).jpg" && id==="12"){ activeTokenPowers.neq = used; }
        pop.remove();
      };
      pop.append(useBtn);
      document.body.appendChild(pop);
      const closer=(e)=>{ if(!pop.contains(e.target)) { pop.remove(); document.removeEventListener('mousedown', closer); } };
      setTimeout(()=>document.addEventListener('mousedown', closer),0);
    };
    bar.appendChild(box);
  });
}

function renderDI(di){
  const box=$("#diBox");
  if(!di){ box.classList.add('hide'); return; }
  box.classList.remove('hide');
  const img = box.querySelector('img');
  img.src = `di${di.index}.png`;
  box.onclick = (ev)=>{
    const pop = el('div','pop');
    const r = ev.currentTarget.getBoundingClientRect();
    pop.style.left = (r.left + window.scrollX) + "px";
    pop.style.top  = (r.top  + window.scrollY - 40) + "px";
    const fwd=el('button','opt'); fwd.textContent="進める";
    const back=el('button','opt'); back.textContent="戻す";
    fwd.onclick=()=>{ const nx=Math.max(0, di.index-1); update(ref(db, `rooms/${my.roomId}/di`), { index:nx }); pop.remove(); };
    back.onclick=()=>{ const nx=Math.min(6, di.index+1); update(ref(db, `rooms/${my.roomId}/di`), { index:nx }); pop.remove(); };
    pop.append(fwd,back);
    document.body.appendChild(pop);
    const closer=(e)=>{ if(!pop.contains(e.target)) { pop.remove(); document.removeEventListener('mousedown', closer); } };
    setTimeout(()=>document.addEventListener('mousedown', closer),0);
  };
}

/* ====== ミッション文面 ====== */
function missionDetailText(no){
  // 表示フォーマットに従い、太字「#番号 ミッション名」を含む
  if(no===1){
    const xs=[1.5,2.5,3.5,4.5]; const x= xs[Math.floor(Math.random()*xs.length)];
    return `<b>#1 爆弾</b><br/>xが1つ`.replace('x', x);
  }
  if(no===2){
    return `<b>#2</b><br/>自分の手札の内1枚がランダムに選ばれて、それを手札の一番右側に置く。それ以外は昇順。`;
  }
  if(no===3){
    const pool=[1.5,2.5,3.5,4.5]; shuffle(pool); const pick=pool.slice(0,3);
    return `<b>#3 さらい爆弾</b><br/>x – y - zのうち1つ`.replace('x',pick[0]).replace('y',pick[1]).replace('z',pick[2]);
  }
  return `<b>#${no}</b>`;
}

/* ====== ユーティリティ ====== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* ====== 画像ファイル名は UI に出さない（参照のみ） ====== */
/* キャラクター：member (1|2|3|4|5).jpg
   裏：battery.jpg
   カード裏：codeback.png
   カード帯：codenumber.png / redcode.png / yellowcode.png
   アイテム：item (..).jpg / 使用後：itemback.jpg
   DI：di0.png..di6.png
*/

/* ===== 初期UI ===== */
$("#btnSit").disabled=false; $("#btnStand").disabled=true;

</script>
</body>
</html>
