<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BOMB BUSTERS</title>
<style>
:root {
  --bg: #ffffff;
  --panel: #f8f8f8;
  --line: #ccc;
  --muted: #666;
  --text: #000;
  --accent: #2196f3;
  --danger: #f44336;
}

* { box-sizing: border-box; margin:0; padding:0; }
html,body { height:100%; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); }

.wrap { max-width: 1200px; margin: 0 auto; padding: 8px; }
.card { background: var(--panel); border:1px solid var(--line); border-radius: 8px; }

header { display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--line); }
header h1 { font-size:18px; margin:0; }
header .badge { background:#eee; padding:2px 8px; border-radius: 999px; font-size: 12px; }

.layout { display:grid; grid-template-columns: 220px 1fr 220px; gap:8px; padding:8px; }
@media(max-width: 720px){ .layout { grid-template-columns: 1fr; } }

.panel { background:#fff; border:1px solid var(--line); border-radius:8px; padding:8px; }

#join { display:grid; gap:8px; }
.row { display:flex; gap:6px; flex-wrap:wrap; }
input, select, button { border:1px solid #ccc; padding:6px 8px; border-radius:6px; font-size:14px; }
button { cursor:pointer; background: var(--accent); color:#fff; border:none; }
button.secondary { background:#aaa; }
button:disabled { opacity:0.5; cursor:not-allowed; }

.list h3 { font-size:14px; margin:6px 0; }
.pill { display:inline-flex; align-items:center; padding:4px 8px; border:1px solid #ccc; border-radius:999px; margin:2px; font-size:12px; background:#f5f5f5; }
.me { outline:2px solid var(--accent); }
.host { border-color:#ff9800; }

#table { display:grid; gap:8px; }
.seat { border:1px solid #ddd; border-radius:6px; padding:6px; }
.meta { font-size:12px; color:var(--muted); margin-bottom:6px; }

.cards { display:flex; justify-content:center; gap:4px; }
.cardv {
  flex: 0 0 auto;
  border-radius:4px;
  border:1px solid #999;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  background:#fff;
}
.mine.face { background:#e3f2fd; border-color:#64b5f6; }
.back { background:#ddd; }

.settings { position:fixed; bottom:10px; right:10px; }
</style>
</head>
<body>
<div class="wrap card">
  <header>
    <h1>BOMB BUSTERS</h1>
    <div><span class="badge">v1.0</span></div>
  </header>
  <div class="layout">
    <section class="panel" id="left">
      <div id="join">
        <div class="row">
          <input id="name" placeholder="名前" />
          <input id="room" placeholder="ルーム4桁" maxlength="4" />
        </div>
        <div class="row">
          <select id="role">
            <option value="player">参加</option>
            <option value="spectator">観戦</option>
          </select>
          <button id="enter">入室</button>
        </div>
      </div>
      <div class="controls">
        <button id="start" disabled>ゲーム開始</button>
      </div>
    </section>
    <section class="panel" id="center">
      <div id="table"></div>
    </section>
    <aside class="panel list" id="right">
      <h3>参加者</h3>
      <div id="players"></div>
      <h3>観戦</h3>
      <div id="spectators"></div>
    </aside>
  </div>
</div>
<div class="settings" id="settings" style="display:none;">
  <button id="resetBtn" class="secondary">ゲームリセット</button>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, set, get, update, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpSx_lEcg1j9ExMJsVl5lBqAxOCfmFmSnI",
  authDomain: "chat-68c4c.firebaseapp.com",
  databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
  projectId: "chat-68c4c",
  storageBucket: "chat-68c4c.appspot.com",
  messagingSenderId: "172284325975",
  appId: "1:172284325975:web:6f9bdd77e822c0ea39dd92"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let me = { name:"", room:"", role:"player" };
let host = null;
let gameStarted = false;

const nameEl = document.querySelector('#name');
const roomEl = document.querySelector('#room');
const roleEl = document.querySelector('#role');
const enterBtn = document.querySelector('#enter');
const startBtn = document.querySelector('#start');
const tableEl = document.querySelector('#table');
const playersEl = document.querySelector('#players');
const spectatorsEl = document.querySelector('#spectators');
const joinPanel = document.querySelector('#join');
const settingsEl = document.querySelector('#settings');
const resetBtn = document.querySelector('#resetBtn');

roomEl.addEventListener('input', () => {
  roomEl.value = roomEl.value.replace(/\\D/g,'').slice(0,4);
});
enterBtn.addEventListener('click', joinRoom);
startBtn.addEventListener('click', startGame);
resetBtn.addEventListener('click', resetGame);

async function joinRoom(){
  const name = nameEl.value.trim();
  const room = roomEl.value.trim();
  const role = roleEl.value;
  if(!name || !/^[0-9]{4}$/.test(room)) return alert("名前と4桁ルームを入力");

  const hostRef = ref(db,`rooms/${room}/host`);
  const snap = await get(hostRef);
  if(!snap.exists()) {
    await set(hostRef, name);
    host = name;
  } else {
    host = snap.val();
  }

  me = { name, room, role };
  const playersRef = ref(db,`rooms/${room}/players/${name}`);
  await update(playersRef,{ name, role, online:true });
  onDisconnect(playersRef).remove();

  joinPanel.style.display='none';
  listenRoom();
}

function listenRoom(){
  const roomRef = ref(db,`rooms/${me.room}`);
  onValue(roomRef, snap => {
    if(!snap.exists()) return;
    const data = snap.val();
    gameStarted = !!data.started;
    renderLists(data);
    renderTable(data);
    if(me.name === data.host) {
      startBtn.disabled = gameStarted;
      settingsEl.style.display = gameStarted ? 'block' : 'none';
    }
    if(gameStarted) {
      document.querySelector('#left').style.display='none';
      document.querySelector('#right').style.display='none';
      if(me.role === 'player' && !data.players[me.name]) {
        me.role = 'spectator';
      }
    }
  });
}

function renderLists(data){
  playersEl.innerHTML = '';
  spectatorsEl.innerHTML = '';
  Object.values(data.players||{}).forEach(p=>{
    if(p.role==='player'){
      playersEl.innerHTML += `<span class="pill${p.name===me.name?' me':''}${p.name===data.host?' host':''}">${p.name}</span>`;
    } else {
      spectatorsEl.innerHTML += `<span class="pill">${p.name}</span>`;
    }
  });
}

function renderTable(data){
  tableEl.innerHTML='';
  Object.values(data.players||{}).forEach(p=>{
    const seat = document.createElement('div');
    seat.className='seat';
    seat.innerHTML = `<div class="meta">${p.name}</div>`;
    const cardsWrap = document.createElement('div');
    cardsWrap.className='cards';
    const cards = p.cards||[];
    const cardCount = cards.length||1;
    const cardW = (window.innerWidth - 32) / cardCount;
    cardsWrap.style.setProperty('--cardW', cardW+'px');
    cards.forEach(card=>{
      const div = document.createElement('div');
      div.className='cardv';
      div.style.width=cardW+'px';
      div.style.height=(cardW*1.36)+'px';
      if(p.name===me.name){
        div.classList.add('mine','face');
        div.textContent=card;
      } else if(card.revealed){
        div.textContent=card.num;
      } else {
        div.classList.add('back');
        div.onclick=()=>revealCard(p.name,card);
      }
      cardsWrap.appendChild(div);
    });
    seat.appendChild(cardsWrap);
    tableEl.appendChild(seat);
  });
}

function startGame(){
  const cards = [];
  for(let i=1;i<=12;i++){ cards.push(i,i); }
  shuffle(cards);
  const players = Object.values(document.querySelectorAll('#players .pill')).map(el=>el.textContent);
  const per = Math.floor(cards.length / players.length);
  const updates={};
  players.forEach((n,idx)=>{
    updates[`rooms/${me.room}/players/${n}/cards`] = cards.slice(idx*per,(idx+1)*per).sort((a,b)=>a-b).map(num=>({num}));
  });
  updates[`rooms/${me.room}/started`] = true;
  update(ref(db), updates);
}

function resetGame(){
  update(ref(db,`rooms/${me.room}`), { started:false });
}

function revealCard(playerName, card){
  card.revealed = true;
  update(ref(db,`rooms/${me.room}/players/${playerName}/cards`), card);
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}
</script>
</body>
</html>
