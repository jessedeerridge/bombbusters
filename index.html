<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>BOMB BUSTERS</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* --- 全体的なスタイル --- */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #ffffff;
            color: #333;
            margin: 0;
            padding: 0;
            -webkit-user-select: none; /* テキスト選択を無効化 */
            user-select: none;
            overflow-x: hidden; /* 横スクロールを禁止 */
        }

        .screen {
            display: none;
            width: 100%;
            max-width: 480px; /* スマホサイズを想定した最大幅 */
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
        }

        #lobby-screen { display: block; }
        h1 { text-align: center; }
        button, select {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #f0f0f0; }
        button:disabled { cursor: not-allowed; background-color: #e0e0e0; }
        input[type="text"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        .hidden { display: none !important; }

        /* --- ロビー画面 --- */
        .lobby-controls, .game-options, .player-list-container {
            margin-bottom: 20px;
            text-align: center;
        }
        #room-code-display {
            font-size: 24px;
            font-weight: bold;
            color: #d9534f;
            margin: 10px 0;
        }
        #player-list {
            list-style: none;
            padding: 0;
        }
        #player-list li {
            background: #f9f9f9;
            border: 1px solid #eee;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        #start-game-btn {
            width: 80%;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            background-color: #d9534f;
            color: white;
            border: none;
        }

        /* --- ゲーム画面 --- */
        #game-screen {
            display: none; /* 初期状態は非表示 */
            position: relative;
        }

        /* アイテムエリア */
        #item-area {
            display: flex;
            overflow-x: auto; /* スマホでスクロール可能に */
            padding: 10px 0;
            align-items: center;
            border-bottom: 2px solid #eee;
            margin-bottom: 15px;
        }
        .item-card, #di-counter {
            flex-shrink: 0;
            position: relative;
            cursor: pointer;
            margin-right: 8px;
        }
        .item-card img, #di-counter img {
            display: block;
        }
        .item-card { width: 50px; height: 70px; }
        #di-counter { width: 70px; height: 70px; margin-left: auto; }
        
        .item-card.used {
            opacity: 0.6;
        }

        /* プレイヤーテーブルエリア */
        #players-area {
            width: 100%;
        }
        .player-table {
            display: flex;
            align-items: center;
            width: 100%;
            height: 90px;
            margin-bottom: 15px;
            position: relative;
        }
        .player-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 10px;
        }
        .player-name-display {
            font-size: 16px;
            font-weight: bold;
            border-bottom: 2px solid #333;
            padding-bottom: 2px;
            min-width: 60px; /* 名前表示エリアの最小幅 */
            text-align: center;
        }
        .table-player-name {
            position: absolute;
            top: -5px;
            left: 0;
            font-size: 12px;
            color: #555;
            background: rgba(255, 255, 255, 0.8);
            padding: 1px 3px;
            border-radius: 2px;
        }
        .character-card {
            width: 40px;
            height: 60px;
            margin-top: 5px;
            cursor: pointer;
            border: 1px solid #ccc;
        }

        /* 手札とカード */
        .hand-container {
            display: flex;
            overflow-x: auto; /* 手札がはみ出た場合にスクロール */
            flex-grow: 1;
        }
        .hand {
            display: flex;
            align-items: flex-start; /* カードとアルファベットをグループ化 */
        }
        .card-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 3px;
            position: relative;
        }
        .card {
            width: 24px;
            height: 50px;
            border: 1px solid #333;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            position: relative;
            background-size: cover;
            background-position: center;
        }
        .card-number {
            font-size: 16px;
            padding-top: 2px;
        }
        .card-icon {
            width: 100%;
            height: 15px; /* アイコンの高さを指定 */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom center;
        }
        
        .card.my-card { background-color: #f0f0f0; color: #333; }
        .card.revealed { background-color: #000000; color: #ffffff; }
        .card.face-down { background-image: url('codeback.png'); }

        .card-swap-indicator {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            color: #d9534f;
            animation: fadeOut 5s forwards;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* アルファベットとトークン */
        .alphabet-label {
            font-size: 12px;
            cursor: pointer;
            margin-top: 4px;
            border: 1px solid #aaa;
            width: 18px;
            height: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 3px;
            background-color: #fff;
        }
        .info-token {
            font-size: 12px;
            margin-top: 2px;
            border: 1px solid #333;
            width: 18px;
            height: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 3px;
        }
        .info-token.normal { background-color: #000; color: #fff; }
        .info-token.equal { background-color: #ffc107; color: #000; }
        .info-token.not-equal { background-color: #03a9f4; color: #000; }
        .info-token.x1 { background-color: #e91e63; color: #000; }

        /* 設定ボタンとメニュー */
        #settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #555;
            color: white;
            font-size: 24px;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #settings-menu {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
        }
        #settings-menu div {
            padding: 12px 20px;
            cursor: pointer;
        }
        #settings-menu div:hover { background-color: #f0f0f0; }

        /* ポップアップ/モーダル */
        .popup-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .popup-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .popup-content button { margin: 0 10px; }
        #restart-confirm-btn { font-size: 12px; }
        #restart-cancel-btn { font-size: 16px; padding: 10px 20px; }

        /* ミッション詳細 */
        #mission-details-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #fafafa;
            border-radius: 5px;
            height: 150px; /* 高さを固定 */
            overflow-y: auto; /* 縦スクロールを有効化 */
        }
        #mission-title {
            font-weight: bold;
        }

    </style>
</head>
<body>

    <div id="lobby-screen" class="screen">
        <h1>BOMB BUSTERS</h1>
        
        <div class="lobby-controls">
            <input type="text" id="room-code-input" placeholder="ルームコード" maxlength="4">
            <button id="join-room-btn">入室</button>
        </div>
        <div class="lobby-controls">
            <button id="create-room-btn">コード作成</button>
            <div id="room-code-display"></div>
        </div>

        <div class="game-options">
            <label>人数: </label>
            <select id="player-count-select">
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
            <label>ミッション: </label>
            <select id="mission-select">
                <option value="1">#1</option>
                <option value="2">#2</option>
                <option value="3">#3</option>
                <option value="4">#4</option>
                <option value="5">#5</option>
            </select>
        </div>

        <div class="player-list-container">
            <h3>参加者リスト</h3>
            <ul id="player-list"></ul>
        </div>
        
        <div style="text-align: center;">
            <button id="start-game-btn" disabled>爆弾を解除！</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div id="item-area">
            <div id="di-counter"><img src="di4.png"></div>
        </div>

        <div id="players-area">
            </div>

        <button id="settings-btn" class="hidden">⚙️</button>
        <div id="settings-menu" class="hidden">
            </div>
        
        <div id="mission-details-container">
            <div id="mission-title"></div>
            <div id="mission-body"></div>
        </div>
    </div>

    <div id="popup-container" class="hidden"></div>


    <script>
        // Firebase設定（ここにあなたの情報を入力してください）
        const firebaseConfig = {
            apiKey: "AIzaSyBpSx_lEcg1j9ExMJsVl5lBqAxOCfmFmSnI",
            authDomain: "chat-68c4c.firebaseapp.com",
            databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
            projectId: "chat-68c4c",
            storageBucket: "chat-68c4c.appspot.com",
            messagingSenderId: "172284325975",
            appId: "1:172284325975:web:6f9bdd77e822c0ea39dd92"
        };

        // Firebaseの初期化
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- グローバル変数 ---
        let currentRoomId = null;
        let currentPlayerId = null;
        let currentPlayerName = null;
        let isHost = false;
        let roomDataUnsubscriber = null; // リアルタイム更新の購読解除用

        // --- DOM要素 ---
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const roomCodeInput = document.getElementById('room-code-input');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const playerCountSelect = document.getElementById('player-count-select');
        const missionSelect = document.getElementById('mission-select');
        const playerList = document.getElementById('player-list');
        const startGameBtn = document.getElementById('start-game-btn');
        const playersArea = document.getElementById('players-area');
        const itemArea = document.getElementById('item-area');
        const diCounter = document.getElementById('di-counter');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const popupContainer = document.getElementById('popup-container');
        const missionTitleEl = document.getElementById('mission-title');
        const missionBodyEl = document.getElementById('mission-body');


        // --- ユーティリティ関数 ---

        // ランダムなひらがな3文字の名前を生成
        const generatePlayerName = () => {
            const hiragana = "あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん";
            let name = "";
            for (let i = 0; i < 3; i++) {
                name += hiragana[Math.floor(Math.random() * hiragana.length)];
            }
            return name;
        };

        // 配列をシャッフル（Fisher-Yatesアルゴリズム）
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        // --- ロビー機能 ---

        // ルーム作成
        createRoomBtn.addEventListener('click', async () => {
            isHost = true;
            const newRoomId = Math.floor(1000 + Math.random() * 9000).toString();
            roomCodeDisplay.textContent = newRoomId;
            roomCodeInput.value = newRoomId;
            roomCodeInput.disabled = true;
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;

            await joinRoom(newRoomId);
        });

        // ルーム入室
        joinRoomBtn.addEventListener('click', () => {
            const roomId = roomCodeInput.value.trim();
            if (roomId.length === 4) {
                joinRoom(roomId);
            } else {
                alert('4桁のルームコードを入力してください。');
            }
        });
        
        // 人数やミッションの選択をホストのみ可能にし、Firebaseに保存
        [playerCountSelect, missionSelect].forEach(select => {
            select.addEventListener('change', () => {
                if (isHost && currentRoomId) {
                    const updates = {};
                    updates[`/rooms/${currentRoomId}/settings/playerCount`] = parseInt(playerCountSelect.value);
                    updates[`/rooms/${currentRoomId}/settings/missionId`] = parseInt(missionSelect.value);
                    db.ref().update(updates);
                }
            });
        });

        // 共通の入室処理
        const joinRoom = async (roomId) => {
            const roomRef = db.ref(`rooms/${roomId}`);
            const snapshot = await roomRef.once('value');
            
            // 新規ルーム作成処理
            if (isHost && !snapshot.exists()) {
                currentPlayerId = db.ref().push().key;
                currentPlayerName = generatePlayerName();
                
                const initialRoomData = {
                    hostId: currentPlayerId,
                    players: {
                        [currentPlayerId]: { name: currentPlayerName, joinedAt: firebase.database.ServerValue.TIMESTAMP }
                    },
                    settings: {
                        playerCount: parseInt(playerCountSelect.value),
                        missionId: parseInt(missionSelect.value)
                    },
                    status: 'lobby',
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };
                await roomRef.set(initialRoomData);
            } 
            // 既存ルームへの参加処理
            else if (!isHost && snapshot.exists()) {
                const roomData = snapshot.val();
                if (Object.keys(roomData.players || {}).length >= roomData.settings.playerCount) {
                    alert('このルームは満員です。');
                    return;
                }
                 if (roomData.status !== 'lobby') {
                    alert('このゲームは既に開始されています。');
                    return;
                }

                currentPlayerId = db.ref().push().key;
                currentPlayerName = generatePlayerName();
                await roomRef.child('players').child(currentPlayerId).set({
                    name: currentPlayerName,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                });
            } else if (!isHost && !snapshot.exists()){
                 alert('ルームが見つかりません。');
                 return;
            }

            currentRoomId = roomId;
            // ページを離れるときにプレイヤーを削除する
            window.addEventListener('beforeunload', handleBeforeUnload);
            listenToRoomUpdates(roomId);
        };
        
        // ページ離脱時の処理
        const handleBeforeUnload = () => {
            if (currentRoomId && currentPlayerId) {
                const playerRef = db.ref(`rooms/${currentRoomId}/players/${currentPlayerId}`);
                playerRef.remove(); // 同期的に削除
            }
        };

        // ルーム情報のリアルタイム監視
        const listenToRoomUpdates = (roomId) => {
            if (roomDataUnsubscriber) roomDataUnsubscriber(); // 古いリスナーを解除
            const roomRef = db.ref(`rooms/${roomId}`);
            roomDataUnsubscriber = roomRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    // ルームが削除された場合
                    alert('ルームが解散しました。');
                    resetToLobby();
                    return;
                }
                const roomData = snapshot.val();
                
                // プレイヤーが誰もいなくなったらルームを削除
                if (isHost && (!roomData.players || Object.keys(roomData.players).length === 0)) {
                    db.ref(`rooms/${currentRoomId}`).remove();
                    return;
                }
                
                if (roomData.status === 'lobby') {
                    updateLobbyUI(roomData);
                } else if (roomData.status === 'playing') {
                    // 監視を続けるが、UIのレンダリングは renderGameUI で制御
                    renderGameUI(roomData);
                }
            });
        };

        // ロビーUIの更新
        const updateLobbyUI = (roomData) => {
            lobbyScreen.style.display = 'block';
            gameScreen.style.display = 'none';

            // 参加者リストを更新
            playerList.innerHTML = '';
            const players = roomData.players || {};
            Object.values(players).forEach(player => {
                const li = document.createElement('li');
                li.textContent = player.name;
                playerList.appendChild(li);
            });
            
            // ホスト用のUI制御
            if (isHost) {
                startGameBtn.disabled = Object.keys(players).length !== roomData.settings.playerCount;
                playerCountSelect.disabled = false;
                missionSelect.disabled = false;
            } else {
                startGameBtn.style.display = 'none';
                playerCountSelect.disabled = true;
                missionSelect.disabled = true;
                playerCountSelect.value = roomData.settings.playerCount;
                missionSelect.value = roomData.settings.missionId;
            }
        };
        
        // ロビー状態にリセット
        const resetToLobby = () => {
             if (roomDataUnsubscriber) roomDataUnsubscriber();
             window.removeEventListener('beforeunload', handleBeforeUnload);
             
             currentRoomId = null;
             currentPlayerId = null;
             currentPlayerName = null;
             isHost = false;
             
             lobbyScreen.style.display = 'block';
             gameScreen.style.display = 'none';
             settingsBtn.classList.add('hidden');
             
             roomCodeInput.value = '';
             roomCodeInput.disabled = false;
             roomCodeDisplay.textContent = '';
             createRoomBtn.disabled = false;
             joinRoomBtn.disabled = false;
             playerList.innerHTML = '';
             startGameBtn.disabled = true;
             startGameBtn.style.display = 'block';
        };

        // --- ゲーム開始処理 ---
        startGameBtn.addEventListener('click', () => {
            if (isHost) {
                initializeGame();
            }
        });
        
        // ゲームの初期化
        const initializeGame = async () => {
            const roomRef = db.ref(`rooms/${currentRoomId}`);
            const snapshot = await roomRef.once('value');
            const roomData = snapshot.val();
            
            const playerCount = roomData.settings.playerCount;
            const missionId = roomData.settings.missionId;
            const playerIds = Object.keys(roomData.players);
            
            // 1. カード生成
            let cards = [];
            for (let i = 1; i <= 12; i++) {
                cards.push(i, i, i, i);
            }
            
            let missionParams = {};
            // ミッションに応じたカード変更
            if (missionId === 1 || missionId === 3) {
                const redCodes = [1.5, 2.5, 3.5, 4.5];
                let chosenCard;
                if (missionId === 1) {
                    chosenCard = redCodes[Math.floor(Math.random() * redCodes.length)];
                    missionParams.x = chosenCard;
                }
                if (missionId === 3) {
                    const shuffledRed = shuffleArray([...redCodes]);
                    missionParams.x = shuffledRed[0];
                    missionParams.y = shuffledRed[1];
                    missionParams.z = shuffledRed[2];
                    chosenCard = shuffledRed[Math.floor(Math.random() * 3)];
                }
                cards.push(chosenCard); // 25枚ではなく、1枚追加して49枚
            }

            cards = shuffleArray(cards);
            
            // 2. カード配布
            const hands = {};
            playerIds.forEach(pid => {
                hands[pid] = { cards: [], tokens: {} };
            });
            
            let p_idx = 0;
            cards.forEach(card => {
                hands[playerIds[p_idx]].cards.push({ value: card, isRevealed: false });
                p_idx = (p_idx + 1) % playerCount;
            });
            
            // 各手札をソート
            Object.values(hands).forEach(hand => {
                hand.cards.sort((a, b) => a.value - b.value);
            });
            
            // ミッション2の処理
            if (missionId === 2) {
                Object.values(hands).forEach(hand => {
                    if(hand.cards.length > 1) {
                        const randomIndex = Math.floor(Math.random() * hand.cards.length);
                        const [removedCard] = hand.cards.splice(randomIndex, 1);
                        hand.cards.push(removedCard);
                    }
                });
            }

            // 3. 役割とキャラクターカード配布
            const shuffledPlayerIds = shuffleArray([...playerIds]);
            const captainId = shuffledPlayerIds[0];
            const characterCards = {};
            const availableChars = [1, 2, 3, 4];
            shuffleArray(availableChars);

            shuffledPlayerIds.forEach((pid, index) => {
                if (pid === captainId) {
                    characterCards[pid] = { number: 5, isFlipped: false };
                } else {
                    // 隊長以外に1-4を割り当てる
                    characterCards[pid] = { number: availableChars.pop(), isFlipped: false };
                }
            });

            // 4. アイテムカード配布
            let allItems = [1,2,3,4,5,6,7,8,9,10,11,12,13]; // 14-18はミッション42まで出ない
            // TODO: 将来的にミッション番号でアイテムプールを切り替える
            // if (missionId > 42) allItems.push(14, 15, 16, 17, 18);
            
            shuffleArray(allItems);
            const items = {};
            for (let i = 0; i < playerCount; i++) {
                items[i] = { id: allItems[i], used: false };
            }
            
            // 5. ゲーム状態をFirebaseに書き込む
            const gameState = {
                hands: hands,
                characterCards: characterCards,
                captainId: captainId, // 表示はしないが、データとして保持
                items: items,
                diCounter: playerCount,
                tables: Array(playerCount).fill(null).map((_, i) => ({ seat: null })),
                missionParams: missionParams || {}
            };
            
            const updates = {};
            updates[`/rooms/${currentRoomId}/status`] = 'playing';
            updates[`/rooms/${currentRoomId}/gameState`] = gameState;
            
            await db.ref().update(updates);
        };

        // --- ゲーム画面の描画 ---
        
        const renderGameUI = (roomData) => {
            if (lobbyScreen.style.display !== 'none') {
                lobbyScreen.style.display = 'none';
                gameScreen.style.display = 'block';
                settingsBtn.classList.remove('hidden');
            }

            const { settings, gameState, players } = roomData;
            const myHand = gameState.hands[currentPlayerId];
            const myTableIndex = gameState.tables.findIndex(t => t.seat === currentPlayerId);
            const amISeated = myTableIndex !== -1;

            // 1. アイテムエリア描画
            renderItems(gameState.items, gameState.hands);
            
            // 2. DIカウンター描画
            diCounter.innerHTML = `<img src="di${gameState.diCounter}.png" alt="DI Counter">`;

            // 3. プレイヤーテーブル描画
            playersArea.innerHTML = '';
            gameState.tables.forEach((table, tableIndex) => {
                const seatedPlayerId = table.seat;
                const seatedPlayer = seatedPlayerId ? players[seatedPlayerId] : null;
                const handData = gameState.hands[Object.keys(gameState.hands)[tableIndex]]; // TODO: この紐付けは不安定。IDで紐づけるべき。
                
                const tableDiv = document.createElement('div');
                tableDiv.className = 'player-table';
                
                // プレイヤー情報（名前/数字、キャラクターカード）
                const playerInfoDiv = document.createElement('div');
                playerInfoDiv.className = 'player-info';
                
                const nameDisplay = document.createElement('div');
                nameDisplay.className = 'player-name-display';
                nameDisplay.textContent = seatedPlayer ? seatedPlayer.name : (tableIndex + 1);
                
                const charCardImg = document.createElement('img');
                charCardImg.className = 'character-card';
                const charCardData = seatedPlayerId ? gameState.characterCards[seatedPlayerId] : null;

                if (amISeated && seatedPlayerId && charCardData) {
                    charCardImg.src = charCardData.isFlipped ? 'battery.jpg' : `member (${charCardData.number}).jpg`;
                } else {
                     charCardImg.src = 'member (blank).jpg'; // 仮のブランク画像
                }
                charCardImg.dataset.tableIndex = tableIndex;

                playerInfoDiv.append(nameDisplay, charCardImg);

                // 手札コンテナ
                const handContainerDiv = document.createElement('div');
                handContainerDiv.className = 'hand-container';
                const handDiv = document.createElement('div');
                handDiv.className = 'hand';

                handData.cards.forEach((card, cardIndex) => {
                    const cardWrapper = document.createElement('div');
                    cardWrapper.className = 'card-wrapper';

                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card';
                    cardDiv.dataset.tableIndex = tableIndex;
                    cardDiv.dataset.cardIndex = cardIndex;
                    
                    const canSeeCard = amISeated && (tableIndex === myTableIndex) || card.isRevealed;

                    if (canSeeCard) {
                        cardDiv.classList.add(card.isRevealed ? 'revealed' : 'my-card');
                        const numberSpan = document.createElement('span');
                        numberSpan.className = 'card-number';
                        numberSpan.textContent = card.value;
                        
                        const iconDiv = document.createElement('div');
                        iconDiv.className = 'card-icon';
                        if (card.value.toString().includes('.5')) {
                             iconDiv.style.backgroundImage = "url('redcode.png')";
                        } else if (card.value.toString().includes('.1')) {
                            iconDiv.style.backgroundImage = "url('yellowcode.png')";
                        } else {
                            iconDiv.style.backgroundImage = "url('codenumber.png')";
                        }
                        cardDiv.append(numberSpan, iconDiv);
                    } else {
                         cardDiv.classList.add('face-down');
                    }

                    // アルファベットラベル
                    const alphabet = String.fromCharCode(97 + cardIndex); // a, b, c...
                    const alphabetLabel = document.createElement('div');
                    alphabetLabel.className = 'alphabet-label';
                    alphabetLabel.textContent = alphabet;
                    alphabetLabel.dataset.tableIndex = tableIndex;
                    alphabetLabel.dataset.cardIndex = cardIndex;
                    
                    cardWrapper.append(cardDiv, alphabetLabel);

                    // 情報トークン
                    const tokenValue = handData.tokens ? handData.tokens[alphabet] : null;
                    if (tokenValue) {
                        const tokenDiv = document.createElement('div');
                        tokenDiv.className = 'info-token';
                        tokenDiv.textContent = tokenValue.value;
                        tokenDiv.classList.add(tokenValue.type || 'normal');
                        cardWrapper.appendChild(tokenDiv);
                    }
                    
                    // カード交換インジケーター
                    if (card.showSwapIndicator) {
                        const indicator = document.createElement('div');
                        indicator.className = 'card-swap-indicator';
                        indicator.textContent = '▼';
                        cardDiv.appendChild(indicator);
                        // 5秒後にFirebaseからフラグを削除する
                        setTimeout(() => {
                            const handKey = Object.keys(gameState.hands)[tableIndex];
                            db.ref(`rooms/${currentRoomId}/gameState/hands/${handKey}/cards/${cardIndex}/showSwapIndicator`).remove();
                        }, 5000);
                    }

                    handDiv.appendChild(cardWrapper);
                });
                handContainerDiv.appendChild(handDiv);
                
                tableDiv.append(playerInfoDiv, handContainerDiv);

                // 着席プレイヤー名（左上）
                if (seatedPlayer) {
                    const tableName = document.createElement('div');
                    tableName.className = 'table-player-name';
                    tableName.textContent = seatedPlayer.name;
                    tableDiv.appendChild(tableName);
                }
                playersArea.appendChild(tableDiv);
            });

            // 4. ミッション詳細描画
            renderMissionDetails(settings.missionId, gameState.missionParams);
        };
        
        // ミッション詳細の表示
        const renderMissionDetails = (missionId, params) => {
            let title = '', body = '';
            switch(missionId) {
                case 1:
                    title = "#1 爆弾";
                    body = `${params.x}が1つ`;
                    break;
                case 2:
                    title = "#2 シャッフル";
                    body = `手札の1枚が一番右に移動しています。`;
                    break;
                case 3:
                    title = "#3 さらい爆弾";
                    body = `${params.x} - ${params.y} - ${params.z} のうち1つ`;
                    break;
                // 他のミッションもここに追加
                default:
                    title = `#${missionId} 未設定のミッション`;
                    body = 'ミッション詳細がありません。';
            }
            missionTitleEl.textContent = title;
            missionBodyEl.textContent = body;
        };

        // アイテムの描画と有効/無効化
        const renderItems = (items, hands) => {
            const itemContainer = itemArea.querySelector('#di-counter'); // di-counterを基準に挿入
            // 既存のアイテムをクリア
            itemArea.querySelectorAll('.item-card').forEach(el => el.remove());
            
            Object.values(items).forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-card';
                if(item.used) itemDiv.classList.add('used');
                
                const itemImg = document.createElement('img');
                itemImg.src = item.used ? 'itemback.jpg' : `item (${item.id}).jpg`;
                itemImg.style.width = '50px';
                itemImg.style.height = '70px';
                
                itemDiv.appendChild(itemImg);
                itemDiv.dataset.itemId = item.id;
                
                // アイテム13の有効化条件
                if (item.id === 13) {
                    let yellowRevealedCount = 0;
                    Object.values(hands).forEach(hand => {
                        hand.cards.forEach(card => {
                            if (card.isRevealed && card.value.toString().includes('.1')) {
                                yellowRevealedCount++;
                            }
                        });
                    });
                    if (yellowRevealedCount < 2) {
                        itemDiv.style.opacity = '0.5';
                        itemDiv.style.pointerEvents = 'none';
                    }
                }
                
                itemArea.insertBefore(itemDiv, itemContainer);
            });
        };

        // --- ゲーム中のインタラクション ---
        
        // 設定ボタン
        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const roomData = JSON.parse(document.body.dataset.roomData || '{}');
            const amISeated = roomData.gameState.tables.some(t => t.seat === currentPlayerId);

            settingsMenu.innerHTML = '';
            if (amISeated) {
                const leaveSeat = document.createElement('div');
                leaveSeat.textContent = '席を立つ';
                leaveSeat.onclick = handleLeaveSeat;
                settingsMenu.appendChild(leaveSeat);
            } else {
                const sitDown = document.createElement('div');
                sitDown.textContent = '席に座る';
                sitDown.onclick = handleSitDown;
                settingsMenu.appendChild(sitDown);
            }
            
            if (isHost) {
                const restart = document.createElement('div');
                restart.textContent = 'やり直す';
                restart.onclick = handleRestart;
                settingsMenu.appendChild(restart);
            }

            settingsMenu.classList.toggle('hidden');
        });
        
        // 席を立つ
        const handleLeaveSeat = () => {
             const roomRef = db.ref(`rooms/${currentRoomId}`);
             roomRef.once('value').then(snapshot => {
                 const roomData = snapshot.val();
                 const myTableIndex = roomData.gameState.tables.findIndex(t => t.seat === currentPlayerId);
                 if (myTableIndex !== -1) {
                     db.ref(`rooms/${currentRoomId}/gameState/tables/${myTableIndex}/seat`).set(null);
                 }
                 settingsMenu.classList.add('hidden');
             });
        };
        
        // 席に座る
        const handleSitDown = () => {
            // TODO: 空いている席を選択するUIを実装
            // 今は単純に最初の空席に座る
             const roomRef = db.ref(`rooms/${currentRoomId}`);
             roomRef.once('value').then(snapshot => {
                 const roomData = snapshot.val();
                 const availableTableIndex = roomData.gameState.tables.findIndex(t => t.seat === null);
                 if (availableTableIndex !== -1) {
                     db.ref(`rooms/${currentRoomId}/gameState/tables/${availableTableIndex}/seat`).set(currentPlayerId);
                 } else {
                     alert("空いている席がありません。");
                 }
                 settingsMenu.classList.add('hidden');
             });
        };
        
        // やり直し
        const handleRestart = () => {
             settingsMenu.classList.add('hidden');
             showPopup(`
                <p>本当にゲームをやり直しますか？</p>
                <button id="restart-cancel-btn">キャンセル</button>
                <button id="restart-confirm-btn">やり直す</button>
             `, (popupEl) => {
                 popupEl.querySelector('#restart-confirm-btn').onclick = () => {
                     // ロビー状態に戻す
                    db.ref(`rooms/${currentRoomId}/status`).set('lobby');
                    db.ref(`rooms/${currentRoomId}/gameState`).remove();
                    hidePopup();
                 };
                 popupEl.querySelector('#restart-cancel-btn').onclick = hidePopup;
             });
        };
        
        // ポップアップ表示
        const showPopup = (html, callback) => {
            popupContainer.innerHTML = `<div class="popup-overlay"><div class="popup-content">${html}</div></div>`;
            popupContainer.classList.remove('hidden');
            if (callback) callback(popupContainer.querySelector('.popup-content'));
        };

        const hidePopup = () => {
            popupContainer.classList.add('hidden');
            popupContainer.innerHTML = '';
        };

        // メニュー外クリックで閉じる
        document.addEventListener('click', () => {
            if (!settingsMenu.classList.contains('hidden')) {
                settingsMenu.classList.add('hidden');
            }
        });
        
        // 汎用クリックイベントリスナー
        document.addEventListener('click', (e) => {
            const target = e.target;
            const roomDataRef = db.ref(`rooms/${currentRoomId}`);

            // カードクリック
            if (target.closest('.card')) {
                const cardEl = target.closest('.card');
                const { tableIndex, cardIndex } = cardEl.dataset;
                
                roomDataRef.once('value').then(snapshot => {
                    const roomData = snapshot.val();
                    const myTableIndex = roomData.gameState.tables.findIndex(t => t.seat === currentPlayerId);
                    
                    if (parseInt(tableIndex) === myTableIndex) {
                        // 自分のカード（現在は機能なし）
                    } else {
                        // 他人のカードを公開
                        const handKey = Object.keys(roomData.gameState.hands)[tableIndex];
                        db.ref(`rooms/${currentRoomId}/gameState/hands/${handKey}/cards/${cardIndex}/isRevealed`).set(true);
                    }
                });
            }
            
            // キャラクターカードクリック
            if (target.matches('.character-card')) {
                const { tableIndex } = target.dataset;
                 roomDataRef.once('value').then(snapshot => {
                    const roomData = snapshot.val();
                    const seatedPlayerId = roomData.gameState.tables[tableIndex].seat;
                    if(seatedPlayerId){
                       const currentFlipState = roomData.gameState.characterCards[seatedPlayerId].isFlipped;
                       db.ref(`rooms/${currentRoomId}/gameState/characterCards/${seatedPlayerId}/isFlipped`).set(!currentFlipState);
                    }
                 });
            }
            
            // アルファベットクリック
            if (target.matches('.alphabet-label')) {
                 roomDataRef.once('value').then(snapshot => {
                    const roomData = snapshot.val();
                    const { tableIndex, cardIndex } = target.dataset;
                    const handKey = Object.keys(roomData.gameState.hands)[tableIndex];
                    const cardValue = roomData.gameState.hands[handKey].cards[cardIndex].value;
                    const alphabet = String.fromCharCode(97 + parseInt(cardIndex));
                    
                    // TODO: トークン選択UIを実装
                    // とりあえず数字トークンを置く
                    const tokenData = { value: cardValue, type: 'normal' };
                    db.ref(`rooms/${currentRoomId}/gameState/hands/${handKey}/tokens/${alphabet}`).set(tokenData);
                 });
            }
            
             // DIカウンタークリック
            if(target.closest('#di-counter')){
                // TODO: 「進める」「戻す」のUIを出す
                // とりあえずクリックで進める
                roomDataRef.child('gameState/diCounter').transaction(currentVal => {
                    return (currentVal > 0) ? currentVal - 1 : currentVal;
                });
            }

        });


        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            // セッションストレージからIDを復元しようと試みる（リロード対策）
            const storedRoomId = sessionStorage.getItem('bombBustersRoomId');
            const storedPlayerId = sessionStorage.getItem('bombBustersPlayerId');
            const storedPlayerName = sessionStorage.getItem('bombBustersPlayerName');
            const storedIsHost = sessionStorage.getItem('bombBustersIsHost') === 'true';

            if (storedRoomId && storedPlayerId) {
                currentRoomId = storedRoomId;
                currentPlayerId = storedPlayerId;
                currentPlayerName = storedPlayerName;
                isHost = storedIsHost;
                
                // プレイヤーがまだルームに存在するか確認
                db.ref(`rooms/${currentRoomId}/players/${currentPlayerId}`).once('value', snapshot => {
                    if (snapshot.exists()) {
                         // 存在すればリスナーを再設定
                         window.addEventListener('beforeunload', handleBeforeUnload);
                         listenToRoomUpdates(currentRoomId);
                    } else {
                        // 存在しなければリセット
                        sessionStorage.clear();
                        resetToLobby();
                    }
                });
            }
        });
        
        // 状態をセッションストレージに保存
        const saveSession = () => {
             if (currentRoomId && currentPlayerId) {
                sessionStorage.setItem('bombBustersRoomId', currentRoomId);
                sessionStorage.setItem('bombBustersPlayerId', currentPlayerId);
                sessionStorage.setItem('bombBustersPlayerName', currentPlayerName);
                sessionStorage.setItem('bombBustersIsHost', isHost);
            }
        };
        
        // 監視関数内で定期的にセッションを保存
        const originalListenFn = listenToRoomUpdates;
        listenToRoomUpdates = (roomId) => {
            saveSession();
            originalListenFn(roomId);
        }

        // bodyにデータを保持して他関数から参照可能にする（簡易的な状態管理）
         const originalRenderFn = renderGameUI;
         renderGameUI = (roomData) => {
            document.body.dataset.roomData = JSON.stringify(roomData);
            originalRenderFn(roomData);
         }


    </script>
</body>
</html>
