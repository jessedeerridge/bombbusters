<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BOMB　BUSTERS</title>
<style>
  :root{
    --card-w:24px;      /* 手札カード */
    --card-h:50px;
    --card-gap:3px;
    --char-w:40px;      /* キャラクターカード */
    --char-h:60px;
    --item-w:50px;      /* アイテムカード */
    --item-h:80px;
    --di-w:70px;        /* DI画像 */
    --di-h:70px;
    --table-h:90px;     /* テーブル高さ固定 */
    --font-card:16px;   /* 数字フォントサイズ */
    --font-weight:bold; /* 数字フォント太さ */
  }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee}
  h1{margin:0;font-size:18px}
  .small{font-size:12px;opacity:.75}

  main{padding:10px 12px;display:flex;gap:12px}
  .col{flex:1;min-width:0}
  .side{width:38%;max-width:420px}

  .join-box{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .join-box input{padding:8px;border:1px solid #ddd;border-radius:6px}
  .btn{padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#f8f8f8;cursor:pointer}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .btn.small{padding:6px 10px;font-size:12px}
  .btn.big{padding:12px 14px;font-size:16px}
  .btn.ghost{background:transparent}
  .hidden{display:none!important}

  /* 右下の歯車 */
  .fab{position:fixed;right:12px;bottom:12px;width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:#111;color:#fff;cursor:pointer}
  .menu{position:fixed;right:12px;bottom:64px;display:flex;flex-direction:column;gap:6px;background:#fff;border:1px solid #eee;border-radius:10px;padding:8px;box-shadow:0 12px 24px rgba(0,0,0,.08)}
  .menu .btn{width:200px;text-align:left}

  /* アイテム行（画面上部に1列だけ） */
  .items-bar{display:flex;align-items:center;gap:8px;margin-top:10px}
  .items{display:flex;gap:6px;align-items:center;overflow-x:auto}
  .item{
    width:var(--item-w);height:var(--item-h);border:1px solid #ddd;border-radius:8px;background:#fff;
    background-size:cover;background-position:center;position:relative;cursor:pointer;flex:0 0 auto
  }
  .item.used{background:#fff url('./itemback.jpg') center/cover no-repeat}
  .di{
    margin-left:auto;width:var(--di-w);height:var(--di-h);border-radius:10px;border:1px solid #ddd;background:#fff;
    background-size:cover;background-position:center;cursor:pointer;flex:0 0 auto
  }

  /* テーブル群（縦並び） */
  .tables{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .table{
    border:1px dashed #ddd;border-radius:10px;padding:8px;position:relative;
    height:var(--table-h);display:flex;flex-direction:column;gap:6px;overflow:hidden
  }
  .header{display:flex;align-items:center;gap:8px;font-size:12px}
  .title{ text-decoration:underline; padding-right:6px } /* 左にアンダーライン＋数字or名前 */

  /* キャラカードは左上の数字/名前の「下」に表示 */
  .char-card{
    width:var(--char-w);height:var(--char-h);
    background-size:cover;background-position:center;border-radius:6px;border:1px solid #ddd;
    cursor:pointer;user-select:none
  }

  /* 手札（中央） */
  .hand{display:flex;align-items:flex-start;gap:var(--card-gap);overflow-x:auto;padding-bottom:2px}
  .card{
    width:var(--card-w);height:var(--card-h);border-radius:6px;border:1px solid #ddd;position:relative;
    background:#bbb; /* 自分の未公開（薄灰） */
    flex:0 0 auto;display:flex;align-items:flex-start;justify-content:center;cursor:pointer;user-select:none
  }
  .card.back{background:#fff url('./codeback.png') center/cover no-repeat;border-color:#ccc} /* 裏面 */
  .card.open{background:#000} /* 公開時は黒地 */
  .num{
    position:absolute;top:2px;left:0;right:0;text-align:center;
    font-size:var(--font-card);font-weight:var(--font-weight);color:#fff;line-height:1;text-shadow:0 1px 0 rgba(0,0,0,.15)
  }
  .img-bottom{
    position:absolute;left:1px;right:1px;bottom:1px;height:18px;border-radius:0 0 6px 6px;
    background-size:cover;background-position:center
  }

  /* アルファベット列（外側の下） */
  .alpha-row{display:flex;gap:var(--card-gap);margin-top:4px}
  .alpha{width:var(--card-w);text-align:center;font-size:11px;cursor:pointer;user-select:none}
  .token{margin-top:2px;font-size:11px;border-radius:4px;padding:1px 0}
  .token.equal{background:#ffedd5;color:#000}   /* ＝ */
  .token.noteq{background:#e0f2fe;color:#000}   /* ≠ */
  .token.x1{background:#fce7f3;color:#000}      /* x1 */
  .token.black{background:#000;color:#fff}      /* 黒地白字（No.16用など） */

  /* ミニポップ（トークンやDIの小タブ） */
  .mini-pop{
    position:fixed;z-index:50;background:#fff;border:1px solid #eee;border-radius:8px;padding:6px;box-shadow:0 8px 20px rgba(0,0,0,.08);
    display:flex;gap:6px
  }

  /* 右パネル */
  .panel{display:flex;flex-direction:column;gap:10px}
  .list{border:1px solid #eee;border-radius:10px;padding:8px}
  .list h3{margin:0 0 6px 0;font-size:13px}
  .name{padding:4px 6px;border-radius:6px}
  .muted{opacity:.6}
  .mission{border:1px solid #eee;border-radius:10px;padding:10px}
  .mission h3{margin:0 0 8px 0;font-size:14px}
  .bold{font-weight:700}

  /* やり直し確認（小/大ボタン） */
  .restart-pop{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.12);
    padding:14px;z-index:60;display:flex;flex-direction:column;gap:10px;min-width:260px
  }
  .restart-actions{display:flex;gap:8px;align-items:center}
  .restart-actions .btn:first-child{font-size:11px;padding:4px 8px} /* すごく小さい「やり直す」 */
  .restart-actions .btn.big{flex:1} /* 大きいキャンセル */
</style>
</head>
<body>
<header>
  <h1>BOMB　BUSTERS</h1>
  <div class="small" id="meName"></div>
</header>

<main>
  <div class="col">
    <!-- 入室UI -->
    <div class="join-box" id="joinBox">
      <input id="roomCode" placeholder="ルームコード" maxlength="12" />
      <button class="btn" id="btnSpectate">観戦で入室</button>
      <button class="btn primary" id="btnJoin">参加で入室</button>
      <button class="btn ghost" id="btnRandom">コード作成</button>
      <span class="small">入室後、右下の歯車から席を決められます</span>
    </div>

    <!-- ロビー/ゲーム -->
    <div id="lobby" class="hidden">
      <div class="row" style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <button class="btn primary" id="btnStart" title="ホストのみ">爆弾を解除！</button>
        <span class="small" id="startHint">（ホストのみ押せます）</span>
      </div>

      <!-- アイテム行（待機中は非表示） -->
      <div class="items-bar hidden" id="itemsBar">
        <div class="items" id="items"></div>
        <div class="di" id="di"></div>
      </div>

      <!-- テーブル（縦並び） -->
      <div class="tables" id="tables"></div>

      <!-- 設定FAB -->
      <button class="fab hidden" id="gear" title="設定">⚙</button>
      <div class="menu hidden" id="menuPopup">
        <button class="btn" id="btnSit">席に座る</button>
        <button class="btn" id="btnLeaveSeat">席を立つ</button>
        <button class="btn" id="btnRestart">やり直す</button>
      </div>
    </div>
  </div>

  <div class="col side">
    <div class="panel">
      <div class="list" id="listsBox">
        <h3>参加者</h3>
        <div id="players"></div>
        <h3 style="margin-top:10px">観戦者</h3>
        <div id="spectators"></div>
      </div>
      <div class="mission" id="missionBox">
        <h3>ミッション</h3>
        <div class="bold">#1　爆弾</div>
        <div>x が1つ</div>
        <div class="bold" style="margin-top:6px">#3　さらい爆弾</div>
        <div>x – y – z のうち1つ</div>
        <div class="small" style="margin-top:8px">（詳細は画面下部へ。ファイル名は表示しません）</div>
      </div>
    </div>
  </div>
</main>

<!-- ミニポップ（トークン） -->
<div id="miniPop" class="mini-pop hidden">
  <button class="btn small" id="tokenPlace">トークンを置く</button>
  <button class="btn small ghost" id="tokenCancel">キャンセル</button>
</div>

<!-- やり直し確認 -->
<div id="restartPop" class="restart-pop hidden">
  <div style="font-size:14px">やり直しますか？</div>
  <div class="restart-actions">
    <button class="btn">やり直す</button>
    <button class="btn big">キャンセル</button>
  </div>
</div>

<script type="module">
/* ===== Firebase v9 (modular) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getDatabase, ref, get, set, update, remove,
  onValue, onDisconnect
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* === 提供された設定をそのまま使用 === */
const firebaseConfig = {
  apiKey: "AIzaSyBpSx_lEcg1j9ExMJsVl5lBqAxOCfmFmSnI",
  authDomain: "chat-68c4c.firebaseapp.com",
  databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
  projectId: "chat-68c4c",
  storageBucket: "chat-68c4c.appspot.com",
  messagingSenderId: "172284325975",
  appId: "1:172284325975:web:6f9bdd77e822c0ea39dd92"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ====== 状態 ====== */
const state = {
  roomCode:null, userId:crypto.randomUUID(), userName:hiragana3(),
  isHost:false, mode:null, gameStarted:false, seatedTable:null, watching:null
};

/* ====== 要素 ====== */
const meName = document.getElementById('meName');
const joinBox= document.getElementById('joinBox');
const inputCode = document.getElementById('roomCode');
const btnJoin = document.getElementById('btnJoin');
const btnSpect= document.getElementById('btnSpectate');
const btnRandom=document.getElementById('btnRandom');

const lobby   = document.getElementById('lobby');
const btnStart= document.getElementById('btnStart');
const startHint=document.getElementById('startHint');

const itemsBar= document.getElementById('itemsBar');
const itemsEl = document.getElementById('items');
const diEl    = document.getElementById('di');

const tablesEl= document.getElementById('tables');
const gear    = document.getElementById('gear');
const menuPop = document.getElementById('menuPopup');
const btnSit  = document.getElementById('btnSit');
const btnLeave= document.getElementById('btnLeaveSeat');
const btnRestart=document.getElementById('btnRestart');
const restartPop=document.getElementById('restartPop');

const playersEl=document.getElementById('players');
const specsEl  =document.getElementById('spectators');
const listsBox =document.getElementById('listsBox');

const miniPop = document.getElementById('miniPop');
const tokenPlace=document.getElementById('tokenPlace');
const tokenCancel=document.getElementById('tokenCancel');

meName.textContent = `あなた：${state.userName}`;

/* ====== ひらがな3文字 ====== */
function hiragana3(){
  const h=[..."あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん"];
  return Array.from({length:3},()=>h[Math.random()*h.length|0]).join('');
}

/* ====== ユーティリティ ====== */
const H = (el,b)=> el.classList.toggle('hidden', !!b);
function pos(el,x,y){el.style.left=x+'px';el.style.top=y+'px';}
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]]}return a}

/* ====== 入室 ====== */
btnRandom.onclick = ()=>{ inputCode.value = String(Math.random()*1e6|0).padStart(6,'0'); };
btnJoin.onclick   = ()=> enter('player');
btnSpect.onclick  = ()=> enter('spectator');

async function enter(mode){
  const code=(inputCode.value||"").trim();
  if(!code){ alert('コードを入力してください'); return; }
  state.roomCode = code; state.mode=mode;

  const roomRef = ref(db, `rooms/${code}`);
  const snap=await get(roomRef);

  if(!snap.exists()){
    // 新規作成 → 入った人がホスト
    state.isHost=true;
    await set(roomRef, baseRoom(state.userId));
  }else{
    state.isHost = snap.val()?.hostId === state.userId;
  }

  // 参加 or 観戦リストに追加
  const path = mode==='player' ? `players/${state.userId}` : `spectators/${state.userId}`;
  await set(ref(db, `rooms/${code}/${path}`), {name:state.userName, at:Date.now()});

  // 切断時に自動退出 → 残0ならルーム自動削除
  onDisconnect(ref(db, `rooms/${code}/players/${state.userId}`)).remove();
  onDisconnect(ref(db, `rooms/${code}/spectators/${state.userId}`)).remove();

  // リスナ開始
  listenRoom(code);

  H(joinBox,true);
  H(lobby,false);
  H(gear,false);
}

/* ====== ルーム初期構造 ====== */
function baseRoom(hostId){
  return {
    createdAt: Date.now(),
    hostId, started:false,
    tableCount:0, tables:[],
    items:[],
    di:{value:0,max:6},
    captainTable:null,
    players:{}, spectators:{}
  };
}

/* ====== 監視 ====== */
function listenRoom(code){
  onValue(ref(db, `rooms/${code}`),(snap)=>{
    const v=snap.val();
    state.watching=v;

    // 全員退出なら自動削除
    if(v){
      const p=Object.keys(v.players||{}).length, s=Object.keys(v.spectators||{}).length;
      if(p===0 && s===0){ remove(ref(db, `rooms/${code}`)); return; }
    }

    // 右の参加/観戦リスト（開始後は非表示）
    H(listsBox, !!v?.started);

    renderLists(v);
    renderItemsAndDi(v);
    renderTables(v);

    state.gameStarted=!!v?.started;
    H(btnStart, !(state.isHost && !state.gameStarted));
    H(startHint, !(state.isHost && !state.gameStarted));
  });
}

/* ====== 参加/観戦リスト描画 ====== */
function renderLists(v){
  playersEl.innerHTML=''; specsEl.innerHTML='';
  if(!v) return;
  Object.values(v.players||{}).forEach(u=>{
    const d=document.createElement('div'); d.className='name'; d.textContent=u.name||'(?)'; playersEl.appendChild(d);
  });
  Object.values(v.spectators||{}).forEach(u=>{
    const d=document.createElement('div'); d.className='name muted'; d.textContent=u.name||'(?)'; specsEl.appendChild(d);
  });
}

/* ====== アイテム & DI（待機中は非表示） ====== */
function renderItemsAndDi(v){
  if(!v || !v.started){ H(itemsBar,true); return; }
  H(itemsBar,false);

  // アイテム
  itemsEl.innerHTML='';
  (v.items||[]).forEach((it, idx)=>{
    const div=document.createElement('div');
    div.className='item' + (it.used?' used':'');
    if(!it.used) div.style.backgroundImage = `url("./item (${it.no}).jpg")`;
    div.onclick=(ev)=>{
      // タップ → 「使用する/キャンセル」
      openMini(ev.clientX, ev.clientY,
        '使用する', async ()=>{
          await update(ref(db, `rooms/${state.roomCode}/items/${idx}`), {used:true});
          // 効果フックはここに（＝/≠/x1等の発火）
        },
        'キャンセル', ()=>{}
      );
    };
    itemsEl.appendChild(div);
  });

  // DI
  const val = clamp(v.di?.value ?? v.tableCount, 0, 6);
  diEl.style.backgroundImage = `url("./di${val}.png")`;
  diEl.onclick=(ev)=>{
    openMini(ev.clientX, ev.clientY,
      '進める', async ()=>{
        const now=state.watching?.di?.value ?? val; const next=clamp(now-1,0,6);
        await update(ref(db, `rooms/${state.roomCode}/di`), {value:next});
      },
      '戻す', async ()=>{
        const now=state.watching?.di?.value ?? val; const next=clamp(now+1,0,6);
        await update(ref(db, `rooms/${state.roomCode}/di`), {value:next});
      }
    );
  };
}

/* ====== テーブル描画 ====== */
function renderTables(v){
  tablesEl.innerHTML='';
  if(!v) return;
  (v.tables||[]).forEach((t, idx)=>{
    const box=document.createElement('div'); box.className='table';

    // 左のアンダーライン…着席済みなら「名前」、未着なら「番号」
    const header=document.createElement('div'); header.className='header';
    const title=document.createElement('div');  title.className='title';
    title.textContent = t.playerName ? t.playerName : String(t.titleNumber ?? (idx+1));
    header.appendChild(title); box.appendChild(header);

    // キャラカード（誰でも裏返せる）
    const char=document.createElement('div'); char.className='char-card';
    const face = t.character?.flipped ? './battery.jpg' : `./${t.character?.face || 'member (1).jpg'}`;
    char.style.backgroundImage = `url("${face}")`;
    char.title='キャラクターカード';
    char.onclick=async ()=>{
      await update(ref(db, `rooms/${state.roomCode}/tables/${idx}/character`), {flipped: !t.character?.flipped});
    };
    box.appendChild(char);

    // 手札
    const hand=document.createElement('div'); hand.className='hand';
    (t.hand||[]).forEach((c,ci)=>{
      const card=document.createElement('div'); card.className='card';
      const isMine = c.ownerId === state.userId;

      if(!isMine && !c.open) card.classList.add('back');   // 他人の未公開は裏
      if(c.open) card.classList.add('open');               // 公開は黒地

      // クリック（自分のカードだけトグル）
      if(isMine){
        card.onclick=async ()=>{
          await update(ref(db, `rooms/${state.roomCode}/tables/${idx}/hand/${ci}`), {open: !c.open});
        };
      }

      const num=document.createElement('div'); num.className='num';
      num.textContent=String(c.num);
      num.style.visibility = (c.open || isMine) ? 'visible' : 'hidden';
      card.appendChild(num);

      // 下詰め画像（通常/赤/黄）…表示のみ。ファイル名はUIに出さない
      const bot=document.createElement('div'); bot.className='img-bottom';
      let img='codenumber.png';
      if(c.kind==='red') img='redcode.png';
      if(c.kind==='yellow') img='yellowcode.png';
      bot.style.backgroundImage=`url("./${img}")`;
      if(card.classList.contains('back')) bot.style.display='none';
      card.appendChild(bot);

      hand.appendChild(card);
    });
    box.appendChild(hand);

    // アルファベット列（外側の下）
    const arow=document.createElement('div'); arow.className='alpha-row';
    (t.hand||[]).forEach((c,ci)=>{
      const a=document.createElement('div'); a.className='alpha'; a.textContent=c.alpha||'';
      // 既存トークン描画
      if(c.token){
        const tk=document.createElement('div');
        tk.className='token ' + (c.token.style||'');
        tk.textContent = c.token.type==='num' || c.token.style==='black' ? c.token.value : c.token.type;
        a.appendChild(tk);
      }
      // 自分のカードのアルファベットだけ反応 → ミニタブ「トークンを置く」
      if(c.ownerId===state.userId){
        a.onclick=(ev)=>{
          openMiniToken(ev.clientX, ev.clientY, async ()=>{
            await update(ref(db, `rooms/${state.roomCode}/tables/${idx}/hand/${ci}`), {
              token:{type:'num', value:c.num, style:null}
            });
          });
        };
      }
      arow.appendChild(a);
    });
    box.appendChild(arow);

    tablesEl.appendChild(box);
  });
}

/* ====== ミニポップ ====== */
let tokenCb=null;
function openMiniToken(x,y, cb){
  tokenCb=cb; pos(miniPop,x,y); H(miniPop,false);
}
tokenPlace.onclick = ()=>{ tokenCb&&tokenCb(); H(miniPop,true); tokenCb=null; };
tokenCancel.onclick= ()=>{ H(miniPop,true); tokenCb=null; };

function openMini(x,y, leftText,leftCb, rightText,rightCb){
  const div=document.createElement('div'); div.className='mini-pop'; pos(div,x,y);
  const b1=document.createElement('button'); b1.className='btn small'; b1.textContent=leftText;
  const b2=document.createElement('button'); b2.className='btn small ghost'; b2.textContent=rightText;
  b1.onclick=()=>{ if(div.isConnected) div.remove(); leftCb&&leftCb(); };
  b2.onclick=()=>{ if(div.isConnected) div.remove(); rightCb&&rightCb(); };
  div.appendChild(b1); div.appendChild(b2);
  document.body.appendChild(div);
  setTimeout(()=>{ if(div.isConnected) div.remove(); }, 6000);
}

/* ====== 歯車メニュー ====== */
gear.onclick=()=> menuPop.classList.toggle('hidden');
document.addEventListener('click',(e)=>{
  if(!gear.contains(e.target) && !menuPop.contains(e.target)) H(menuPop,true);
}, true);

/* ====== 席に座る/立つ ====== */
btnSit.onclick = async ()=>{
  if(state.mode!=='player'){ alert('観戦入室では席に座れません。参加で入り直してください。'); return; }
  const v=state.watching; if(!v?.started){ alert('ゲーム開始後に席を選べます'); return; }
  const empties=(v.tables||[]).map((t,i)=> t.playerId?null:i).filter(i=>i!==null);
  if(!empties.length){ alert('空席がありません'); return; }
  const s=prompt(`空席番号を入力：${empties.map(i=>i+1).join(', ')}`); if(!s) return;
  const pick=(parseInt(s,10)||0)-1; if(!empties.includes(pick)){ alert('その席は選べません'); return; }

  // 着席 → playerName設定 & 手札オーナー付与
  await update(ref(db, `rooms/${state.roomCode}/tables/${pick}`), {playerId:state.userId, playerName:state.userName});
  const hand=v.tables[pick].hand||[];
  await Promise.all(hand.map((_,i)=> update(ref(db, `rooms/${state.roomCode}/tables/${pick}/hand/${i}`), {ownerId:state.userId})));
  state.seatedTable=pick;
};

btnLeave.onclick = async ()=>{
  const v=state.watching; if(state.seatedTable==null){ alert('席に座っていません'); return; }
  const idx=state.seatedTable;
  await update(ref(db, `rooms/${state.roomCode}/tables/${idx}`), {playerId:null, playerName:null});
  const hand=v.tables[idx].hand||[];
  await Promise.all(hand.map((_,i)=> update(ref(db, `rooms/${state.roomCode}/tables/${idx}/hand/${i}`), {ownerId:null})));
  state.seatedTable=null;
};

/* ====== やり直し ====== */
btnRestart.onclick = ()=>{
  if(!state.isHost){ alert('ホストのみ操作可'); return; }
  H(restartPop,false);
};
restartPop.querySelectorAll('.btn')[0].onclick = async ()=>{
  H(restartPop,true);
  const v=state.watching; if(!v) return;
  await startGame(v.tableCount); // 同数で再配布
};
restartPop.querySelectorAll('.btn')[1].onclick = ()=> H(restartPop,true);

/* ====== ゲーム開始 ====== */
btnStart.onclick = async ()=>{
  if(!state.isHost) return;
  const pc = clamp(parseInt(prompt('プレイ人数（2〜6目安）','4')||'4',10),1,6);
  await startGame(pc);
};

async function startGame(playerCount){
  if(!state.isHost) return;
  const code=state.roomCode;

  // テーブル生成（縦並び／高さ固定）
  const captainIndex = Math.floor(Math.random()*playerCount);
  const faces=[1,2,3,4];
  shuffle(faces);
  const tables=[];
  for(let i=0;i<playerCount;i++){
    const face = (i===captainIndex) ? 'member (5).jpg' : `member (${faces[(i%4)]}).jpg`;
    tables.push({
      titleNumber:i+1,
      playerId:null, playerName:null,
      character:{face, flipped:false},
      hand:[]
    });
  }

  // デッキ（1..12 ×4）をシャッフルし、均等でなくても余りなく順番配り
  const deck=[];
  for(let n=1;n<=12;n++){ for(let k=0;k<4;k++) deck.push({num:n, kind:'normal', open:false, ownerId:null}); }
  shuffle(deck);

  const alpha="abcdefghijklmnopqrstuvwxyz";
  let p=0;
  while(p<deck.length){
    for(let t=0; t<playerCount && p<deck.length; t++){
      const c=deck[p++];
      const a = alpha[ tables[t].hand.length % alpha.length ];
      tables[t].hand.push({...c, alpha:a, token:null});
    }
  }

  // アイテム（待機中は非表示）…人数ぶん配布。ミッション42までは14〜18を除外 → ここでは除外。
  const all=[1,2,3,4,5,6,7,8,9,10,11,12/*,13,14,15,16,17,18*/];
  shuffle(all);
  const items = all.slice(0, Math.min(playerCount, all.length)).map(no=>({id:crypto.randomUUID(),no,used:false}));

  // 反映
  await set(ref(db, `rooms/${code}`), {
    ...(state.watching||baseRoom(state.userId)),
    hostId: state.watching?.hostId || state.userId,
    started:true,
    tableCount:playerCount,
    tables, items,
    di:{value:playerCount, max:6}, // 開始時は「di＋プレイ人数」
    captainTable: captainIndex
  });

  // UI
  H(gear,false);
}

/* ====== クリック外しでミニポップ閉じる ====== */
document.addEventListener('click',(e)=>{
  if(!miniPop.contains(e.target)){ H(miniPop,true); }
}, true);
</script>
</body>
</html>
