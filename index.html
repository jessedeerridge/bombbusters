<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BOMB BUSTERS</title>
  <style>
    :root{
      --bg:#fff; --ink:#111; --muted:#666; --line:#e6e6e6; --accent:#0ea5e9; --danger:#ef4444;
      --cardW:24px; --cardH:50px; --charW:40px; --charH:60px; --gap:3px;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif}
    header{position:sticky;top:0;background:#fffccf;border-bottom:1px solid var(--line);z-index:10}
    .wrap{max-width:820px;margin:0 auto;padding:10px}
    h1{margin:6px 0 0;font-size:20px;letter-spacing:1px}

    /* --- Top bar / room controls --- */
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="text"], input[type="number"]{padding:8px;border:1px solid var(--line);border-radius:8px;font-size:16px}
    button{padding:10px 14px;border:1px solid var(--line);background:#fff;border-radius:10px;font-weight:600}
    button.primary{background:#111;color:#fff;border-color:#111}
    button.ghost{background:#fff}
    button.small{padding:6px 10px;font-size:12px}
    .muted{color:var(--muted)}

    /* --- Lobby lists --- */
    .lobby{display:flex;gap:12px;overflow-x:auto;padding:6px 0}
    .pill{border:1px solid var(--line);padding:6px 10px;border-radius:999px;white-space:nowrap}

    /* --- Settings (gear) --- */
    .gear{position:fixed;right:12px;bottom:12px;width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:#111;color:#fff;z-index:50}
    .panel{position:fixed;inset:auto 8px 72px 8px;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.1);max-height:55vh;overflow:auto;padding:10px}
    .panel h3{margin:8px 6px}
    .panel .tablist{display:flex;gap:8px;overflow:auto;padding:8px}
    .panel .tablist button{flex:0 0 auto}

    /* --- Tables (players) --- */
    .tables{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .table{border:1px dashed var(--line);border-radius:14px;padding:8px;min-height:90px;position:relative}
    .seatTitle{position:absolute;left:8px;top:6px;font-size:12px;color:var(--muted)}
    .seatTitle .name{font-weight:700;border-bottom:1px solid #ccc}

    /* dynamic card row inside each table */
    .cards{display:flex;align-items:flex-start;gap:var(--gap);padding-left:6px;padding-top:22px;flex-wrap:nowrap;overflow-x:auto}

    /* Character card (top of seat) */
    .charCard{width:var(--charW);height:var(--charH);border:1px solid var(--line);border-radius:10px;background:#f5f5f5;display:grid;place-items:center;overflow:hidden}
    .charRow{position:absolute;right:8px;top:8px;display:flex;gap:8px}

    /* Code cards */
    .card{width:var(--cardW);height:var(--cardH);border:1px solid var(--line);border-radius:8px;position:relative;background:#f2f2f2;display:flex;align-items:flex-start;justify-content:center}
    .card .num{position:absolute;top:2px;font-size:16px;font-weight:bold;color:#fff}
    .card.back{background:#ddd url('./images/codeback.png') center/cover no-repeat}
    .card.open{background:#000}
    .plate{position:absolute;left:1px;right:1px;bottom:1px;height:16px;background:#ccc;border-radius:0 0 8px 8px}
    .plate.normal{background:#ccc url('./images/codenumber.png') bottom center/contain no-repeat}
    .plate.red{background:#f87171 url('./images/redcode.png') bottom center/contain no-repeat}
    .plate.yellow{background:#facc15 url('./images/yellowcode.png') bottom center/contain no-repeat}

    /* Letter token row */
    .letter{font-size:10px;border:1px solid var(--line);border-radius:6px;padding:1px 4px;margin-top:2px;display:inline-block;background:#fff}
    .token{font-size:10px;border:1px solid #000;border-radius:6px;padding:1px 4px;margin-top:2px;display:inline-block;background:#000;color:#fff}
    .token.eq{background:#ffedd5;color:#111;border-color:#f97316}
    .token.neq{background:#e0f2fe;color:#111;border-color:#38bdf8}
    .token.x1{background:#fce7f3;color:#111;border-color:#f472b6}

    /* Items */
    .itemsBar{display:flex;gap:8px;overflow:auto;padding:8px 0;border-top:1px solid var(--line);border-bottom:1px solid var(--line);margin-top:10px}
    .item{width:50px;height:70px;border:1px solid var(--line);border-radius:8px;background:#fafafa;flex:0 0 auto;display:grid;place-items:center;position:relative}
    .item.back{background:#ddd url('./images/itemback.jpg') center/cover no-repeat}
    .item .cap{position:absolute;bottom:2px;left:2px;right:2px;font-size:10px;text-align:center;color:#111}

    /* di counter */
    .di{width:70px;height:70px;border:1px solid var(--line);border-radius:12px;background:#f5f5f5;display:grid;place-items:center;flex:0 0 auto}

    /* Dialog / menus */
    dialog{border:1px solid var(--line);border-radius:12px;padding:0}
    dialog .box{padding:14px;max-height:60vh;overflow:auto}
    .menu{position:fixed;z-index:60;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,.12)}
    .menu button{display:block;width:100%;text-align:left;border:0;border-bottom:1px solid var(--line);background:#fff;padding:10px 12px}
    .menu button:last-child{border-bottom:0}

    .hidden{display:none}
    .center{display:grid;place-items:center;min-height:30vh}
    .notice{padding:6px 10px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>BOMB BUSTERS</h1>
      <div class="row" id="roomControls">
        <input id="codeInput" type="text" inputmode="numeric" pattern="\\d{4}" placeholder="コード(4桁)" maxlength="4" />
        <button id="joinBtn" class="primary">入室</button>
        <button id="makeBtn">コード作成</button>
        <span class="muted" id="youSpan"></span>
      </div>
      <div class="row" id="preGameOpts">
        <div class="row">
          <span class="muted">人数:</span>
          <button class="pill" data-cap="4">4</button>
          <button class="pill" data-cap="5">5</button>
        </div>
        <div class="row">
          <span class="muted">ミッション:</span>
          <button class="pill" data-mission="1">#1</button>
          <button class="pill" data-mission="2">#2</button>
          <button class="pill" data-mission="3">#3</button>
          <button class="pill" data-mission="4">#4</button>
          <button class="pill" data-mission="5">#5</button>
        </div>
        <button id="startBtn" class="primary">爆弾を解除！</button>
      </div>
      <div id="lobby" class="lobby hidden"></div>
    </div>
  </header>

  <main class="wrap">
    <!-- Items row appears after game starts -->
    <div id="itemsRow" class="itemsBar hidden"></div>

    <div id="tables" class="tables"></div>

    <section id="missionDetail" style="margin:14px 0"></section>

    <div id="emptyState" class="center">
      <div class="notice">4桁コードを入れて <b>入室</b> するか、<b>コード作成</b> を押してください。</div>
    </div>
  </main>

  <!-- gear button -->
  <button id="gear" class="gear" title="設定"><span aria-hidden>⚙️</span></button>
  <div id="gearPanel" class="panel hidden">
    <div class="tablist">
      <button data-tab="seat">席に座る</button>
      <button data-tab="leave">席を立つ</button>
      <button data-tab="reset">やり直す</button>
    </div>
    <div id="gearBody"></div>
  </div>

  <!-- simple dialogs -->
  <dialog id="confirmReset">
    <div class="box">
      <p>本当にリセットしますか？</p>
      <div class="row" style="justify-content:flex-end">
        <button data-act="cancel">キャンセル</button>
        <button data-act="sure" class="small">やり直す</button>
      </div>
    </div>
  </dialog>

  <!-- letter token menu -->
  <div id="letterMenu" class="menu hidden"></div>

  <script>
  // ============== Firebase ==================
  // NOTE: ファイル名はUIに表示しません（altを空にし、テキスト表示もしない）。
  const firebaseConfig = {
    apiKey: "AIzaSyBpSx_lEcg1j9ExMJsVl5lBqAxOCfmFmSnI",
    authDomain: "chat-68c4c.firebaseapp.com",
    databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
    projectId: "chat-68c4c",
    storageBucket: "chat-68c4c.appspot.com",
    messagingSenderId: "172284325975",
    appId: "1:172284325975:web:6f9bdd77e822c0ea39dd92"
  };
  
  // Firebase v9 modular (via CDN)
  const script = document.createElement('script');
  script.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
  script.onload = () => {
    const s2 = document.createElement('script');
    s2.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';
    s2.onload = boot;
    document.head.appendChild(s2);
  };
  document.head.appendChild(script);

  // ============== App State ==================
  const HIRAGANA = Array.from('あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん');
  const LETTERS = 'abcdefghijklmnopqrstuvwxyz'.split('');

  let app = {
    me: null, // {id, name}
    room: null, // code
    hostId: null,
    seatId: null, // my table index (0..N-1) or null
    mission: 1,
    cap: 4,
    di: 0,
    eqCount: 0, neqCount: 0, x1Count: 0,
  };

  // Utilities
  const $ = sel => document.querySelector(sel);
  const el = (tag, attrs={}, ...kids)=>{
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if(k==='class') n.className=v; else if(k==='text') n.textContent=v; else if(k.startsWith('on')) n.addEventListener(k.slice(2), v); else n.setAttribute(k,v);
    });
    kids.forEach(k=> n.append(k));
    return n;
  };
  const rand = n => Math.floor(Math.random()*n);
  const randomName = ()=> Array.from({length:3},()=> HIRAGANA[rand(HIRAGANA.length)]).join('');
  const id = ()=> Math.random().toString(36).slice(2,10);

  // ============== Boot ==================
  function boot(){
    const appFB = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    window.DB = db;

    // restore (optional)
    const saved = JSON.parse(localStorage.getItem('bb.me')||'null');
    app.me = saved || { id: id(), name: randomName() };
    $('#youSpan').textContent = `あなた: ${app.me.name}`;
    localStorage.setItem('bb.me', JSON.stringify(app.me));

    // UI wiring
    $('#makeBtn').addEventListener('click', ()=> {
      const code = String(1000 + rand(9000));
      $('#codeInput').value = code;
    });
    $('#joinBtn').addEventListener('click', joinRoom);

    // preGame option pills
    $('#preGameOpts').addEventListener('click', (e)=>{
      const t = e.target.closest('button.pill'); if(!t) return;
      if(t.dataset.cap){ app.cap = +t.dataset.cap; }
      if(t.dataset.mission){ app.mission = +t.dataset.mission; }
      render();
    });

    // gear panel toggle
    $('#gear').addEventListener('click', ()=> $('#gearPanel').classList.toggle('hidden'));

    // confirm reset dialog
    $('#confirmReset').addEventListener('click', (e)=>{
      const act = e.target.getAttribute('data-act');
      if(act==='cancel') $('#confirmReset').close();
      if(act==='sure'){ $('#confirmReset').close(); hostReset(); }
    });

    render();
  }

  // ============== Room / DB ==================
  function roomRef(code){ return DB.ref(`rooms/${code}`); }

  async function joinRoom(){
    const code = ($('#codeInput').value||'').replace(/\D/g,'').padStart(4,'0').slice(-4);
    if(!/^\d{4}$/.test(code)) return alert('4桁のコードを入力してください');

    app.room = code;
    const ref = roomRef(code);
    const snap = await ref.get();

    // create or attach
    if(!snap.exists()){
      const hostId = app.me.id;
      await ref.set({
        createdAt: Date.now(),
        hostId, state: 'lobby', cap: app.cap, mission: app.mission,
        players: { [app.me.id]: { id: app.me.id, name: app.me.name, online:true, seat:null } },
        watchers: {},
        tables: [], // will be set on start
        items: [],
        di: 0,
      });
    }else{
      const v = snap.val();
      app.hostId = v.hostId;
      await ref.child(`players/${app.me.id}`).set({ id: app.me.id, name: app.me.name, online:true, seat:null });
    }

    // presence handling
    const myRef = ref.child(`players/${app.me.id}/online`);
    myRef.onDisconnect().set(false);

    // listeners
    ref.on('value', s=>{ stateChanged(s.val()); });
  }

  function stateChanged(v){
    if(!v) return;
    app.hostId = v.hostId; app.cap = v.cap; app.mission = v.mission; app.di = v.di||0;
    // delete empty room (all offline)
    const alive = Object.values(v.players||{}).some(p=>p.online) || Object.values(v.watchers||{}).some(w=>w.online);
    if(!alive){ roomRef(app.room).remove(); return; }

    window.ROOM = v; // debug
    renderRoom(v);
  }

  // Host actions
  async function startGame(){
    const ref = roomRef(app.room);
    const v = (await ref.get()).val();
    const cap = v.cap||4;
    // build tables
    const tables = Array.from({length:cap}, (_,i)=>({
      seat:i, playerId:null, playerName:null,
      leader:false, // 隊長(非表示)
      char: { face: 'blank', hidden:true },
      hand: [], // {id,num,type:'normal|red|yellow', open:false, ownerSeat:i, letter:'a'}
      tokens: {} // letter -> [token strings]
    }));
    // pick one leader
    tables[rand(cap)].leader = true;

    // Prepare deck per mission
    const { deck, missionDetail } = buildDeck(v.mission);
    // deal round-robin up to players count * 15 max without leftover
    const maxLen = Math.ceil(deck.length / cap);
    const hands = Array.from({length:cap}, ()=>[]);
    let i=0; deck.forEach(card=>{ hands[i%cap].push(card); i++; });
    hands.forEach(h=> h.sort((a,b)=>a.value-b.value));

    // assign letters per hand
    hands.forEach((h,si)=>{
      h.forEach((c,idx)=>{ c.letter = LETTERS[idx]||LETTERS[LETTERS.length-1]; c.ownerSeat = si; });
    });

    // tables with hands
    tables.forEach((t,i)=>{ t.hand = hands[i]||[]; });

    // char card distribution
    const faces = [1,2,3,4];
    const shuffled = faces.sort(()=>Math.random()-0.5);
    const specialSeat = rand(cap);
    tables.forEach((t,i)=>{
      if(i===specialSeat){ t.char = {face:5, hidden:false}; } // member (5).jpg
      else { t.char = {face: shuffled[i%4], hidden:false}; }
    });

    await ref.update({ state:'playing', tables, items: initialItems(cap, v.mission), di: cap, missionDetail });
  }

  function buildDeck(mission){
    // card types
    const normal = Array.from({length:12},(_,i)=> i+1 );
    const red = Array.from({length:11},(_,i)=> (i+1)+0.5 );
    const yellow = Array.from({length:11},(_,i)=> (i+1)+0.1 );
    function makeCard(n){
      let type='normal'; if(String(n).includes('.5')) type='red'; else if(String(n).includes('.1')) type='yellow';
      return { id:id(), value:n, type, open:false };
    }

    let deck=[]; let detail='';

    if(mission==1){
      // 1,2,3,4,5の .5 から1枚混入 + (1..12)*2? -> 指示: 25枚
      const choices=[1.5,2.5,3.5,4.5,5.5];
      const x = choices[rand(choices.length)];
      const base = [...normal, ...normal]; // 24枚
      deck = [...base, x].map(makeCard);
      detail = `<b>#1 爆弾</b><br>\n${x}が1つ`;
    } else if(mission==2){
      // ランダムに1枚を各自の一番右へ (配布後にクライアントで処理)
      const base = [...normal, ...normal];
      deck = base.map(makeCard);
      detail = `<b>#2</b><br>\n右端固定のカードが各自1枚`;
    } else if(mission==3){
      // 1.5,2.5,3.5,4.5 から3つ提示し、その中の1つのみ採用、25枚
      const pool=[1.5,2.5,3.5,4.5];
      const shuffled=pool.sort(()=>Math.random()-0.5);
      const xyz=shuffled.slice(0,3);
      const pick=xyz[rand(3)];
      const base=[...normal, ...normal];
      deck=[...base, pick].map(makeCard);
      detail = `<b>#3 さらい爆弾</b><br>\n${xyz.join(' – ')}のうち1つ`;
    } else {
      const base=[...normal, ...normal];
      deck=base.map(makeCard);
      detail = `<b>#${mission}</b>`;
    }

    // shuffle deck
    deck = deck.sort(()=>Math.random()-0.5);
    return { deck, missionDetail: detail };
  }

  function initialItems(cap, mission){
    // missionにより配らない上位番号を除外（〜#42までは14-18配布しない）
    const ids = [1,2,3,4,5,6,7,8,9,10,11,12,13];
    // 各プレイヤーへ1枚（仕様文: 人数対応した1..18をランダム配布 -> ここでは各1枚）
    return Array.from({length:cap}, (_,i)=> ({ id:id(), itemId: ids[rand(ids.length)], used:false }));
  }

  async function hostReset(){
    if(app.me.id!==app.hostId) return;
    const ref = roomRef(app.room);
    await ref.update({ state:'lobby', tables:[], items:[], di:0 });
  }

  // ============== Rendering ==================
  function render(){
    // lobby controls visibility (pre-room)
    $('#preGameOpts').classList.toggle('hidden', !app.room);
    $('#startBtn').onclick = ()=> { if(app.me.id!==app.hostId) return; startGame(); };
  }

  function renderRoom(v){
    $('#emptyState').classList.add('hidden');

    // lobby info
    const lobby = $('#lobby'); lobby.innerHTML='';
    if(v.state==='lobby'){
      lobby.classList.remove('hidden');
      const players = Object.values(v.players||{}).filter(p=>p.online);
      players.forEach(p=> lobby.append(el('span',{class:'pill',text:p.name})));
    } else lobby.classList.add('hidden');

    // start button logic
    $('#startBtn').disabled = (app.me.id!==v.hostId);

    // Items + di counter visibility
    $('#itemsRow').classList.toggle('hidden', v.state!=='playing');

    // Items bar
    if(v.state==='playing'){
      const itemsRow = $('#itemsRow'); itemsRow.innerHTML='';
      (v.items||[]).forEach(it=>{
        const box = el('div',{class:'item'+(it.used?' back':''), title:''});
        const img = el('img',{alt:'', width:46, height:66});
        if(!it.used) img.src = `./images/item (${it.itemId}).jpg`;
        else img.src = `./images/itemback.jpg`;
        box.append(img, el('div',{class:'cap',text:''}));
        box.addEventListener('click', ()=> onItemClick(it));
        itemsRow.append(box);
      });
      // di counter
      const di = el('div',{class:'di'});
      const diImg = el('img',{alt:'', width:66, height:66});
      diImg.src = `./images/di${v.di}.png`;
      di.append(diImg);
      di.addEventListener('click', ()=>{
        const menu = quickMenu([
          {label:'進める', fn:()=> roomRef(app.room).update({ di: Math.max(0, v.di-1) })},
          {label:'戻す', fn:()=> roomRef(app.room).update({ di: Math.min(6, v.di+1) })},
        ]);
        placeMenu(menu, event.clientX, event.clientY);
      });
      itemsRow.append(di);
    }

    // Tables
    const T = $('#tables'); T.innerHTML='';
    const tables = v.tables||[];
    tables.forEach((t,idx)=>{
      const box = el('div',{class:'table'});
      // seat title left-top
      const title = el('div',{class:'seatTitle'});
      const seatLabel = t.playerName ? el('span',{class:'name',text:t.playerName}) : el('span',{text:String(idx+1)});
      title.append(seatLabel, el('span',{text:' _'}));
      box.append(title);

      // character card (top right)
      const charRow = el('div',{class:'charRow'});
      const char = el('div',{class:'charCard'});
      const img = el('img',{alt:'', width:38, height:58});
      if(t.char.hidden) { img.src = './images/battery.jpg'; }
      else if(t.char.face==='blank'){ img.src = ''; }
      else if(t.char.face===5){ img.src = `./images/member (5).jpg`; }
      else { img.src = `./images/member (${t.char.face}).jpg`; }
      char.append(img);
      char.addEventListener('click', ()=> toggleChar(idx));
      charRow.append(char);
      box.append(charRow);

      // codes row
      const row = el('div',{class:'cards'});
      (t.hand||[]).forEach((c,cidx)=>{
        const cd = el('div',{class:'card'+(c.open?' open':'' ) +(c.back?' back':''), title:''});
        if(!c.open && !c.back){ cd.classList.add('back'); }
        const num = el('div',{class:'num',text: formatNum(c.value)});
        cd.append(num);
        const plate = el('div',{class:'plate '+plateClass(c)});
        cd.append(plate);
        // clicking other player's card -> reveal globally
        cd.addEventListener('click', ()=> onCardClick(idx, cidx));
        row.append(cd);

        // letter + tokens under each card
        const letterWrap = el('div');
        const L = el('div',{class:'letter',text:c.letter||''});
        L.addEventListener('click', (ev)=> openLetterMenu(ev, idx, cidx));
        letterWrap.append(L);
        // tokens visual
        (c.tokens||[]).forEach(tk=> letterWrap.append(el('div',{class:'token '+tokenClass(tk), text:tk})) );
        row.append(letterWrap);
      });
      box.append(row);

      T.append(box);
    });

    // gear panel body
    renderGear(v);

    // Mission detail
    $('#missionDetail').innerHTML = v.missionDetail||'';
  }

  function plateClass(c){ return c.type==='red'?'red': (c.type==='yellow'?'yellow':'normal'); }
  function tokenClass(t){ if(t==='=') return 'eq'; if(t==='≠') return 'neq'; if(t==='x1') return 'x1'; return ''; }
  function formatNum(v){ return String(v).replace('.5',''); }

  function renderGear(v){
    const body = $('#gearBody'); body.innerHTML='';
    const seats = (v.tables||[]).map((t,i)=>({i, name: t.playerName||`テーブル${i+1}`, taken: !!t.playerId}));

    // seat tab
    const seatDiv = el('div');
    seats.forEach(s=>{
      const b = el('button',{class:'pill', text:s.name + (s.taken?' (使用中)':'')});
      b.disabled = s.taken && v.players && v.players[app.me.id]?.seat !== s.i;
      b.addEventListener('click', ()=> sitAt(s.i));
      seatDiv.append(b);
    });

    // leave tab
    const leaveDiv = el('div');
    const btnLeave = el('button',{class:'pill', text:'席を立つ'});
    btnLeave.addEventListener('click', ()=> leaveSeat());
    leaveDiv.append(btnLeave);

    // reset tab (host only)
    const resetDiv = el('div');
    const small = el('div',{class:'muted',text:'ホストのみ可'});
    const reBtn = el('button',{class:'pill', text:'やり直し'});
    reBtn.disabled = app.me.id!==v.hostId;
    reBtn.addEventListener('click', ()=> $('#confirmReset').showModal());
    resetDiv.append(small,reBtn);

    // default first tab
    body.append(seatDiv);

    // Tab switcher
    $('#gearPanel').querySelector('.tablist').onclick = (e)=>{
      const t = e.target.closest('button'); if(!t) return;
      const which = t.dataset.tab;
      body.innerHTML='';
      if(which==='seat') body.append(seatDiv);
      if(which==='leave') body.append(leaveDiv);
      if(which==='reset') body.append(resetDiv);
    };
  }

  // ============== Interactions ==================
  async function sitAt(seatIndex){
    if(!ROOM || !ROOM.tables) return;
    const table = ROOM.tables[seatIndex];
    if(table.playerId && table.playerId!==app.me.id) return alert('その席は使用中です');
    await roomRef(app.room).update({ [`tables/${seatIndex}/playerId`]: app.me.id, [`tables/${seatIndex}/playerName`]: app.me.name });
    await roomRef(app.room).child(`players/${app.me.id}/seat`).set(seatIndex);
  }

  async function leaveSeat(){
    if(ROOM && ROOM.players && ROOM.players[app.me.id] && ROOM.players[app.me.id].seat!=null){
      const s = ROOM.players[app.me.id].seat;
      await roomRef(app.room).update({ [`tables/${s}/playerId`]: null, [`tables/${s}/playerName`]: null });
      await roomRef(app.room).child(`players/${app.me.id}/seat`).set(null);
    }
  }

  async function toggleChar(seatIdx){
    if(!ROOM) return; const t=ROOM.tables[seatIdx];
    const now = t.char.hidden; // battery <-> face
    await roomRef(app.room).update({ [`tables/${seatIdx}/char/hidden`]: !now });
  }

  async function onCardClick(seatIdx, cardIdx){
    const t = ROOM.tables[seatIdx];
    const c = t.hand[cardIdx];
    const mySeat = ROOM.players?.[app.me.id]?.seat;

    // 自分の手札のみ、裏/表切替可能。それ以外はクリックで公開(黒背景・白数字)
    if(mySeat===seatIdx){
      const back = !(c.back===true); // toggle back
      await roomRef(app.room).update({ [`tables/${seatIdx}/hand/${cardIdx}/back`]: back, [`tables/${seatIdx}/hand/${cardIdx}/open`]: back?false:c.open });
    } else {
      await roomRef(app.room).update({ [`tables/${seatIdx}/hand/${cardIdx}/open`]: true, [`tables/${seatIdx}/hand/${cardIdx}/back`]: false });
    }
  }

  function quickMenu(items){
    const m = $('#letterMenu');
    m.innerHTML='';
    items.forEach(it=>{
      const b = el('button',{text:it.label, onclick:()=>{ it.fn(); hideMenu(); }});
      m.append(b);
    });
    return m;
  }
  function placeMenu(menu, x, y){ menu.style.left=x+'px'; menu.style.top=y+'px'; menu.classList.remove('hidden'); }
  function hideMenu(){ $('#letterMenu').classList.add('hidden'); }
  document.addEventListener('click', (e)=>{
    if(!e.target.closest('#letterMenu')) hideMenu();
  });

  function openLetterMenu(ev, seatIdx, cardIdx){
    const c = ROOM.tables[seatIdx].hand[cardIdx];
    const nums = Array.from({length:12},(_,i)=> i+1 );
    const tokenItems = nums.map(n=>({label:String(n), fn:()=> addToken(seatIdx, cardIdx, String(n)) }));

    // limits: =, ≠, x1 は各2回まで全体で
    const specials = [];
    if(app.eqCount < 2) specials.push({label:'＝', fn:()=> addToken(seatIdx, cardIdx, '＝')});
    if(app.neqCount < 2) specials.push({label:'≠', fn:()=> addToken(seatIdx, cardIdx, '≠')});
    if(app.x1Count < 2) specials.push({label:'x1', fn:()=> addToken(seatIdx, cardIdx, 'x1')});

    const menu = quickMenu([...specials, ...tokenItems, {label:'消す', fn:()=> clearTokens(seatIdx, cardIdx)}]);
    placeMenu(menu, ev.clientX, ev.clientY);
  }

  async function addToken(seatIdx, cardIdx, tk){
    const path = `tables/${seatIdx}/hand/${cardIdx}/tokens`;
    const cur = (ROOM.tables[seatIdx].hand[cardIdx].tokens)||[];
    const next = [...cur, tk];
    await roomRef(app.room).update({ [path]: next });
    if(tk==='＝') app.eqCount++; if(tk==='≠') app.neqCount++; if(tk==='x1') app.x1Count++;
  }
  async function clearTokens(seatIdx, cardIdx){
    await roomRef(app.room).update({ [`tables/${seatIdx}/hand/${cardIdx}/tokens`]: [] });
  }

  // Items behaviour (subset)
  async function onItemClick(it){
    if(it.used){ // 表にする
      it.used=false; await syncItem(it); return;
    }
    // 使用する → とりあえず種別で分岐 (12:手札交換, 13:条件で+2枚, 9:x1付与 1:=, 13:≠ …)
    if(it.itemId===12){ alert('手札交換: 自分のカード→相手のカード の順でクリックしてください'); swapFlow(); }
    else if(it.itemId===1){ app.eqCount = Math.min(app.eqCount, 2); alert('「＝」トークンが選べます（上限2）'); }
    else if(it.itemId===13){ app.neqCount = Math.min(app.neqCount, 2); alert('「≠」トークンが選べます（上限2）'); }
    else if(it.itemId===9){ app.x1Count = Math.min(app.x1Count, 2); alert('「x1」トークンが選べます（上限2）'); }
    it.used=true; await syncItem(it);
  }
  async function syncItem(it){
    const idx = (ROOM.items||[]).findIndex(x=>x.id===it.id);
    if(idx>=0) await roomRef(app.room).update({ [`items/${idx}`]: it });
  }

  // Swap flow for item 12 (very simplified visual guidance)
  let swapStage = 0; let pickA = null;
  async function swapFlow(){
    swapStage = 1; pickA=null;
    document.body.style.cursor = 'crosshair';
    const handler = async (e)=>{
      const seat = e.target.closest('.table'); if(!seat){ end(); return; }
      const sIdx = Array.from(document.querySelectorAll('.table')).indexOf(seat);
      const cards = seat.querySelectorAll('.card');
      const ci = Array.from(cards).indexOf(e.target.closest('.card'));
      if(ci<0){ end(); return; }
      if(swapStage===1){ pickA = {s:sIdx, c:ci}; swapStage=2; alert('相手のカードを選んでください'); }
      else if(swapStage===2){ const pickB={s:sIdx, c:ci}; await doSwap(pickA, pickB); end(); }
    };
    function end(){ document.body.style.cursor=''; document.removeEventListener('click', handler, true); }
    document.addEventListener('click', handler, true);
  }

  async function doSwap(a,b){
    const A = ROOM.tables[a.s].hand[a.c];
    const B = ROOM.tables[b.s].hand[b.c];
    // remove
    const tA = structuredClone(ROOM.tables[a.s]);
    const tB = structuredClone(ROOM.tables[b.s]);
    tA.hand.splice(a.c,1); tB.hand.splice(b.c,1);
    // insert keeping ascending, left-most among equals
    insertCardSorted(tA.hand, B);
    insertCardSorted(tB.hand, A);
    await roomRef(app.room).update({ [`tables/${a.s}`]: tA, [`tables/${b.s}`]: tB });
    // ▼ marker for 5s (simplified: add token '▼' once; auto-clear after 5s)
    markCard(tA, B); markCard(tB, A);
  }

  function insertCardSorted(arr, card){
    let pos = arr.findIndex(x=> x.value >= card.value );
    if(pos===-1) pos = arr.length; // largest
    arr.splice(pos,0, card);
  }
  async function markCard(table, card){
    const idx = table.hand.findIndex(x=> x===card);
    if(idx<0) return;
    const tokens = (card.tokens||[]).concat('▼');
    await roomRef(app.room).update({ [`tables/${table.seat||0}/hand/${idx}/tokens`]: tokens });
    setTimeout(()=> roomRef(app.room).update({ [`tables/${table.seat||0}/hand/${idx}/tokens`]: (tokens.filter(t=>t!=='▼')) }), 5000);
  }

  </script>
</body>
</html>
