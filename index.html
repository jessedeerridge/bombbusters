<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BOMB BUSTERS</title>
  <style>
    :root{
      --bg:#ffffff; --ink:#111; --muted:#666; --line:#e6e6e6;
      --card-gap:3px; --cardW:24px; --cardH:50px; /* コードカード */
      --charW:40px; --charH:60px; /* キャラクターカード */
      --tableH:90px; 
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Noto Sans",sans-serif}
    h1{margin:12px 12px 8px;font-size:20px;font-weight:800;letter-spacing:.04em}
    .wrap{max-width:960px;margin:0 auto;padding:8px}

    /* 上部コントロール（横スクロール可能） */
    .tabsRow{display:flex;gap:8px;overflow-x:auto;padding:8px;border-bottom:1px solid var(--line)}
    .pill{flex:0 0 auto;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fafafa}
    .pill button{all:unset;cursor:pointer}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){
      .grid{grid-template-columns:2fr 1fr}
    }

    /* 入室パネル */
    .panel{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type=text]{padding:10px;border-radius:8px;border:1px solid var(--line);min-width:140px}
    .btn{border:1px solid #ddd;border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.small{padding:6px 10px;font-size:12px}
    .btn.ghost{background:#f7f7f7}

    /* リスト */
    .list{max-height:200px;overflow:auto;border:1px dashed var(--line);border-radius:10px;padding:8px}
    .subtle{color:var(--muted);font-size:12px}

    /* テーブル（手札置き場） */
    .table{border:1px solid var(--line);border-radius:12px;padding:8px;min-height:var(--tableH);position:relative;overflow:hidden}
    .seatHeader{position:absolute;left:8px;top:6px;font-size:11px;color:var(--muted)}
    .tableLabel{position:absolute;left:8px;bottom:6px;font-variant-numeric:tabular-nums}
    .tableLabel .line{display:inline-block;border-bottom:2px solid #111;min-width:40px}
    .cards{display:flex;gap:var(--card-gap);align-items:flex-start}
    .card{width:var(--cardW);height:var(--cardH);border-radius:6px;border:1px solid #dcdcdc;position:relative;display:flex;align-items:center;justify-content:center;user-select:none}
    .card.mine.hidden{background:#f0f0f0;color:#fff}
    .card.mine.shown{background:#f0f0f0;color:#fff}
    .card.public{background:#000;color:#fff}
    .card .num{position:absolute;top:2px;left:0;right:0;text-align:center;font-size:12px;font-weight:700}
    .card .footImg{position:absolute;bottom:0;left:0;right:0;height:12px;object-fit:cover;border-bottom-left-radius:6px;border-bottom-right-radius:6px}
    .card img.back{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:6px}

    /* アルファベット＆トークン */
    .alphaRow{display:flex;gap:var(--card-gap);margin-top:4px}
    .alpha{min-width:var(--cardW);text-align:center;font-size:11px;border:1px solid #bbb;border-radius:4px;padding:1px 0}
    .token{min-width:var(--cardW);text-align:center;font-size:11px;border:1px solid #111;border-radius:4px;margin-top:2px;padding:1px 0;background:#000;color:#fff}
    .token.eq{background:#ffe8cc;color:#111;border-color:#f5c08f}
    .token.neq{background:#ddf3ff;color:#111;border-color:#9ed0f5}
    .token.x1{background:#ffd9ea;color:#111;border-color:#f5a6c4}

    /* キャラカード */
    .char{width:var(--charW);height:var(--charH);border-radius:8px;border:1px solid #dcdcdc;overflow:hidden;position:relative}
    .char img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

    /* アイテム列（横スクロール） */
    .itemsBar{display:flex;gap:6px;overflow-x:auto;padding:6px 0;border-bottom:1px solid var(--line)}
    .itemCard{flex:0 0 auto;width:50px;height:70px;border:1px solid #ccc;border-radius:8px;position:relative}
    .itemCard img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:8px}

    /* ダイス表示 */
    .dice{flex:0 0 auto;width:70px;height:70px;border:1px solid #ccc;border-radius:10px;position:relative}
    .dice img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:10px}

    /* 設定（右下ギア） */
    .fab{position:fixed;right:12px;bottom:12px;width:54px;height:54px;border-radius:50%;border:1px solid #ddd;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,.08)}

    /* モーダル */
    dialog{border:none;border-radius:14px;padding:0;width:min(92vw,520px)}
    dialog::backdrop{background:rgba(0,0,0,.25)}
    .modal{padding:14px}
    .modal .title{font-weight:700;margin-bottom:8px}
    .menuList{display:flex;flex-direction:column;gap:8px}

    /* 非表示補助 */
    .hide{display:none !important}
  </style>
</head>
<body>
  <h1>BOMB　BUSTERS</h1>
  <div class="wrap">

    <!-- 上段：コード/参加UI（横スクロール可） -->
    <div class="tabsRow" id="topTabs">
      <div class="pill"><div class="row">
        <input id="roomCode" type="text" maxlength="4" inputmode="numeric" placeholder="コード(4桁)" />
        <button class="btn" id="genCode">コード作成</button>
        <button class="btn primary" id="enterAsPlayer">参加</button>
        <button class="btn" id="enterAsViewer">観戦</button>
      </div></div>
      <div class="pill"><div class="row">
        <span class="subtle">人数</span>
        <button class="btn small" data-pc="4">4</button>
        <button class="btn small" data-pc="5">5</button>
      </div></div>
      <div class="pill"><div class="row" id="missionBtns">
        <span class="subtle">ミッション</span>
        <button class="btn small" data-m="1">#1</button>
        <button class="btn small" data-m="2">#2</button>
        <button class="btn small" data-m="3">#3</button>
        <button class="btn small" disabled>#4</button>
        <button class="btn small" disabled>#5</button>
        <button class="btn small" disabled>#6</button>
        <button class="btn small" disabled>#7</button>
        <button class="btn small" disabled>#8</button>
        <button class="btn small" disabled>#9</button>
        <button class="btn small" disabled>#10</button>
      </div></div>
      <div class="pill"><button class="btn primary" id="startGame">爆弾を解除！</button></div>
    </div>

    <!-- アイテム列（ゲーム中のみ表示） -->
    <div class="itemsBar hide" id="itemsBar"></div>

    <div class="grid">
      <!-- 左：テーブル群 -->
      <div id="tablesCol"></div>

      <!-- 右：参加者/観戦者リスト（ゲーム開始前のみ表示） -->
      <div id="listsCol">
        <div class="panel">
          <div class="subtle">あなたの名前</div>
          <div id="myName" style="font-size:18px;font-weight:700;letter-spacing:.1em"></div>
          <div class="subtle">コード</div>
          <div id="codeEcho" style="font-size:18px;font-weight:700;letter-spacing:.1em"></div>
        </div>
        <div class="panel" id="preGamePanel">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:700">参加者…</div>
            </div>
            <div>
              <div class="subtle">観戦者…</div>
            </div>
          </div>
          <div class="row">
            <div class="list" style="flex:1" id="playersList"></div>
            <div class="list" style="flex:1" id="viewersList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ミッション詳細（下スクロールで閲覧） -->
    <div style="margin-top:16px" id="missionRules">
      <!-- ここにJSで #1, #2, #3 の説明を差し込み -->
    </div>
  </div>

  <!-- FAB（設定） -->
  <button class="fab" id="gear" title="設定">⚙️</button>

  <!-- 設定モーダル -->
  <dialog id="gearDlg">
    <div class="modal">
      <div class="title">設定</div>
      <div class="menuList">
        <button class="btn" id="sitBtn">席に座る</button>
        <button class="btn" id="leaveSeatBtn">席を立つ</button>
        <button class="btn" id="resetBtn">やり直し（ホストのみ）</button>
        <div id="resetConfirm" class="hide" style="display:flex;gap:8px">
          <button class="btn small" id="reallyReset">やり直す</button>
          <button class="btn" id="cancelReset">キャンセル</button>
        </div>
        <button class="btn" id="closeGear">閉じる</button>
      </div>
    </div>
  </dialog>

  <!-- 汎用モーダル（選択肢や小さいタブ） -->
  <dialog id="actionDlg"><div class="modal"><div class="title" id="actionTitle"></div><div id="actionBody"></div><div style="margin-top:10px"><button class="btn" id="actionClose">閉じる</button></div></div></dialog>

  <script type="module">
    // ===== Firebase 初期化（モジュラーSDK） =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, child, get, set, update, onValue, onDisconnect, push, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBpSx_lEcg1j9ExMJsVl5lBqAxOCfmFmSnI",
      authDomain: "chat-68c4c.firebaseapp.com",
      databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
      projectId: "chat-68c4c",
      storageBucket: "chat-68c4c.appspot.com",
      messagingSenderId: "172284325975",
      appId: "1:172284325975:web:6f9bdd77e822c0ea39dd92"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ===== ユーティリティ =====
    const $ = sel => document.querySelector(sel);
    const el = (tag, props={}) => Object.assign(document.createElement(tag), props);
    const rand = n => Math.floor(Math.random()*n);
    const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
    const hira = [..."あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん"];
    function randName(){ return hira[rand(hira.length)]+hira[rand(hira.length)]+hira[rand(hira.length)] }
    const letters = [..."abcdefghijklmnopqrstuvwxyz"]; // 26まで

    // 画像パスはUIにファイル名を文字として表示しない（altを空に）
    const imgPath = name => `./assets/${name}`; // GitHub用: /assets 配下に配置してください

    // ===== ローカル状態 =====
    let my = { code:"", uid:"", name: randName(), role:"viewer", host:false, seat:-1 };
    let room = null; // ルームスナップショット

    // ===== DOM =====
    const codeInput = $('#roomCode');
    const codeEcho = $('#codeEcho');
    const myName = $('#myName');
    const playersList = $('#playersList');
    const viewersList = $('#viewersList');
    const startBtn = $('#startGame');
    const itemsBar = $('#itemsBar');
    const tablesCol = $('#tablesCol');
    const listsCol = $('#listsCol');

    myName.textContent = my.name;

    // コード生成（4桁）
    $('#genCode').addEventListener('click', ()=>{
      const n = ('' + Math.floor(1000 + Math.random()*9000));
      codeInput.value = n; codeEcho.textContent = n; my.code = n;
    });

    // 入室
    $('#enterAsPlayer').addEventListener('click', ()=>enter('player'));
    $('#enterAsViewer').addEventListener('click', ()=>enter('viewer'));

    async function enter(role){
      const code = (codeInput.value||'').trim();
      if(!/^\d{4}$/.test(code)){ alert('コードは4桁の数字'); return }
      my.code = code; codeEcho.textContent = code;
      const roomRef = ref(db, `rooms/${code}`);
      const snap = await get(roomRef);
      const exists = snap.exists();
      const now = Date.now();
      // 初回入室でルーム作成
      if(!exists){
        room = {
          createdAt: now,
          players: {}, viewers: {},
          host: '',
          started: false,
          playerCount: 4,
          mission: 1,
          seats: [], // {name, uid, seatedAt}
          tables: [], // runtime
          publicReveals: {}, // {tableIndex:{cardIndex:numberValue}}
          dice: 0,
          items: [],
          captainUid: '',
        };
        await set(roomRef, room);
      } else {
        room = snap.val();
      }
      // UIDを発行
      my.uid = my.uid || push(ref(db, 'uids')).key;
      my.role = role;

      // ホスト決定（先着）
      const isHost = !room.host;
      if(isHost) my.host = true;

      // 参加者 or 観戦者に登録
      const updates = {};
      const userNode = { name: my.name, uid: my.uid, ts: serverTimestamp() };
      if(role==='player'){ updates[`rooms/${code}/players/${my.uid}`] = userNode; }
      else { updates[`rooms/${code}/viewers/${my.uid}`] = userNode; }
      if(isHost){ updates[`rooms/${code}/host`] = my.uid; }
      await update(ref(db), updates);

      // presence: 自分ノードを onDisconnect で削除
      const path = role==='player' ? `rooms/${code}/players/${my.uid}` : `rooms/${code}/viewers/${my.uid}`;
      onDisconnect(ref(db, path)).remove();

      // ルーム監視開始
      watchRoom(code);
    }

    function watchRoom(code){
      onValue(ref(db, `rooms/${code}`), (snap)=>{
        if(!snap.exists()) return;
        room = snap.val();
        renderLists();
        renderTopState();
        renderTables();
        renderItemsAndDice();
      });
    }

    function renderTopState(){
      myName.textContent = my.name + (my.host? '（ホスト）':'' );
      // ゲーム前のみリスト表示
      $('#preGamePanel').classList.toggle('hide', !!room.started);
      // ミッションUI: ホストのみ操作可、開始後は変更不可
      document.querySelectorAll('[data-pc]').forEach(b=>{
        b.disabled = !my.host || room.started;
        b.classList.toggle('primary', room.playerCount==+b.dataset.pc);
      });
      document.querySelectorAll('#missionBtns .btn').forEach(b=>{
        if(!b.dataset.m) return;
        b.disabled = !my.host || room.started;
        b.classList.toggle('primary', room.mission==+b.dataset.m);
      });
      startBtn.disabled = !my.host || room.started;
    }

    function renderLists(){
      playersList.innerHTML = '';
      viewersList.innerHTML = '';
      const ps = room.players? Object.values(room.players) : [];
      const vs = room.viewers? Object.values(room.viewers) : [];
      ps.forEach(u=> playersList.append(el('div',{textContent:u.name})) );
      vs.forEach(u=> viewersList.append(el('div',{textContent:u.name})) );
      // 自分がホストか再判定
      my.host = room.host === my.uid;
    }

    // 人数とミッション選択
    document.querySelectorAll('[data-pc]').forEach(b=> b.addEventListener('click', async()=>{
      if(!my.host || room.started) return; await update(ref(db, `rooms/${my.code}`), { playerCount:+b.dataset.pc });
    }));
    document.querySelectorAll('#missionBtns [data-m]').forEach(b=> b.addEventListener('click', async()=>{
      if(!my.host || room.started) return; await update(ref(db, `rooms/${my.code}`), { mission:+b.dataset.m });
    }));

    // ====== ゲーム開始（配布/席生成） ======
    startBtn.addEventListener('click', async()=>{
      if(!my.host) return;
      const code = my.code; if(!code) return;
      const ps = room.players? Object.values(room.players):[];
      if(ps.length===0){ alert('参加者がいません'); return }
      const playerCount = room.playerCount; // 4 or 5

      // テーブル生成（人数ぶん）
      const tables = Array.from({length:playerCount}, (_,i)=>({
        label:(i+1), name:'', uid:'', cards:[], public:[], // public: 公開された index の真偽 or 値
        letters: letters.slice(0,15), tokens: {}, // tokens[a] = {type:'num'|'eq'|'neq'|'x1', value}
        char: '', charFaceUp:true
      }));

      // 隊長をランダムに（UI非表示）
      const allUids = ps.map(u=>u.uid);
      const captainUid = allUids[rand(allUids.length)];

      // デッキ生成（ミッション適用）
      const {deck, mixInfo} = buildDeck(room.mission);
      // 配布（可能な限り均等、余りなしで順番配り）
      const deal = Array.from({length:tables.length},()=>[]);
      deck.forEach((v,i)=> deal[i%tables.length].push(v));
      // 昇順
      deal.forEach(arr=> arr.sort((a,b)=> a-b));
      tables.forEach((t,i)=>{ t.cards = deal[i]; t.public = Array(t.cards.length).fill(null); });

      // 画像セット：キャラクター
      // 座っていないうちはブランク表示 -> 後で着席時に member(1..5).jpg を割当
      // 仕様：着席済みテーブルには member (5).jpg、それ以外に 1..4 を重複なくランダム
      const charsPool = shuffle([1,2,3,4]);
      tables.forEach((t,i)=>{ t.char = `blank` });

      // サーバへ保存
      await update(ref(db, `rooms/${code}`), {
        started:true,
        tables,
        seats: Array.from({length:tables.length}, ()=>({name:'', uid:'', seatedAt:0})),
        captainUid,
        publicReveals: {},
        mixInfo: mixInfo||null,
        items: buildInitialItems(),
        dice: room.playerCount,
      });
    });

    function buildDeck(mission){
      // 基本デッキ：1..12 が4枚ずつ = 48
      const base = [];
      for(let n=1;n<=12;n++){ for(let i=0;i<4;i++) base.push(n); }
      let mixInfo = null;
      if(mission===1){
        // 1,1.5,2.5,3.5,4.5 のいずれか1枚を混ぜ、合計25枚
        const halfs = [1.5,2.5,3.5,4.5];
        const x = halfs[rand(halfs.length)];
        const deck = shuffle(base).slice(0,24); deck.push(x);
        return { deck: shuffle(deck), mixInfo:{mission:1, x} }
      }
      if(mission===2){
        // 後で：各自の一番右にランダム1枚固定 => デッキは通常48（配布後に加工）
        return { deck: shuffle(base), mixInfo:{mission:2} };
      }
      if(mission===3){
        // 1.5,2.5,3.5,4.5 から x,y,z を重複なしで選び、その中の1つのみを実使用
        const pool = shuffle([1.5,2.5,3.5,4.5]);
        const xyz = pool.slice(0,3);
        const used = xyz[rand(3)];
        const deck = shuffle(base).slice(0,24); deck.push(used);
        return { deck: shuffle(deck), mixInfo:{mission:3, xyz, used} };
      }
      // デフォルト
      return { deck: shuffle(base), mixInfo:null };
    }

    function buildInitialItems(){
      // 仕様：ミッション42までは14-18は配布しない → 現状 1..13,15..17 のうち人数ぶんランダム配布
      // ここでは表示用として 1..13,15..17 を用意（重複可）
      return [1,12,14,2,5].map(n=>({ id: crypto.randomUUID(), kind:n, face:'front', owner:'', used:false }));
    }

    // ===== テーブル描画 =====
    function renderTables(){
      tablesCol.innerHTML = '';
      if(!room.tables) return;
      room.tables.forEach((t,ti)=>{
        const box = el('div',{className:'table', style:`height:var(--tableH)`});
        // 左上：プレイヤー名（小さく）
        const seat = room.seats?.[ti];
        const seatName = seat?.name||'';
        if(seatName){ box.append(el('div',{className:'seatHeader', textContent:seatName})) }
        // 下：テーブルラベル（数字 or 名前）
        const lbl = el('div',{className:'tableLabel'});
        const txt = seatName? seatName: String(t.label);
        lbl.innerHTML = `<span class="line">${txt}</span>`; box.append(lbl);

        // 中：キャラカード + 手札
        const row = el('div',{className:'row'});
        const char = el('div',{className:'char'});
        const charImg = el('img',{alt:"", src: imgPath(seatName? 'member (5).jpg' : 'blank.png')});
        char.append(charImg);
        // クリックで裏返し（battery.jpg）
        char.addEventListener('click', ()=>{
          const up = !t.charFaceUp; // 逆にしない：仕様「誰でも裏返せる」
          // ここは単純トグル
          const next = charImg.getAttribute('data-bak')==='1'? imgPath(seatName? 'member (5).jpg':'blank.png') : imgPath('battery.jpg');
          charImg.src = next; charImg.setAttribute('data-bak', charImg.getAttribute('data-bak')==='1'? '0':'1');
        });
        row.append(char);

        // 手札
        const cardsWrap = el('div');
        cardsWrap.className = 'cards';
        const alphaRow = el('div',{className:'alphaRow'});
        const tokenRow = el('div',{className:'alphaRow'});

        t.cards.forEach((v,ci)=>{
          const mine = seat?.uid === my.uid; // 自分の席？
          const isPublic = !!t.public?.[ci];
          const card = el('div',{className:'card' + (mine? ' mine':'') + (isPublic?' public': (mine?' shown':'') )});
          // 裏面
          if(!mine && !isPublic){
            const back = el('img',{alt:"", className:'back', src: imgPath('codeback.png')});
            card.append(back);
          } else {
            // 表面（数値表示）
            const num = el('div',{className:'num', textContent:String(v)}); card.append(num);
            const foot = el('img',{alt:"", className:'footImg', src: imgPath(codeFootImageFor(v))}); card.append(foot);
          }
          // クリック動作
          card.addEventListener('click', ()=>{
            if(seat?.uid===my.uid){
              // 自分のカード：表裏トグル（自分だけ）
              // 表示はローカルのみ変化（サーバ状態は保持しない）
              if(card.querySelector('img.back')){
                // 裏→表
                card.innerHTML='';
                card.classList.remove('public');
                card.append(el('div',{className:'num',textContent:String(v)}));
                card.append(el('img',{alt:"",className:'footImg',src:imgPath(codeFootImageFor(v))}));
              }else{
                // 表→裏
                card.innerHTML='';
                card.append(el('img',{alt:"",className:'back',src:imgPath('codeback.png')}));
              }
            } else {
              // 他人のカード：公開（全体）
              const path = `rooms/${my.code}/tables/${ti}/public/${ci}`;
              update(ref(db), { [path]: v });
            }
          });

          cardsWrap.append(card);

          // アルファベット
          const L = letters[ci]||'';
          const a = el('div',{className:'alpha', textContent:L});
          // アルファベットクリック → 自分のカードのみトークンUI
          a.addEventListener('click', ()=>{
            if(seat?.uid!==my.uid) return;
            openTokenMenu(ti, ci, L);
          });
          alphaRow.append(a);

          // 情報トークン表示
          const tokData = t.tokens?.[L];
          const tok = el('div',{className:'token' + (tokData? ' '+tokData.type : ''), textContent: tokData? (tokData.type==='num'? tokData.value : tokData.type) : ''});
          tokenRow.append(tok);
        });
        row.append(cardsWrap);
        box.append(row);

        // アルファベット行
        box.append(alphaRow);
        box.append(tokenRow);

        tablesCol.append(box);
      });
    }

    function codeFootImageFor(v){
      // 通常: codenumber.png, 赤: redcode.png, 黄: yellowcode.png
      if(String(v).includes('.5')) return 'redcode.png';
      if(String(v).includes('.1')) return 'yellowcode.png';
      return 'codenumber.png';
    }

    // トークンUI
    function openTokenMenu(ti, ci, L){
      const dlg = $('#actionDlg');
      $('#actionTitle').textContent = `「${L}」にトークンを置く`;
      const body = $('#actionBody');
      body.innerHTML = '';
      const menu = el('div',{className:'row'});
      // 数字1..12
      for(let n=1;n<=12;n++){
        const b = el('button',{className:'btn small', textContent:String(n)});
        b.addEventListener('click', ()=>{
          setToken(ti, L, {type:'num', value:n}); dlg.close();
        });
        menu.append(b);
      }
      body.append(menu);
      // 特殊（=, ≠, x1）はアイテム消費時にのみ付与されるため直接は出さない
      $('#actionClose').onclick = ()=> dlg.close();
      dlg.showModal();
    }

    async function setToken(ti, L, data){
      const path = `rooms/${my.code}/tables/${ti}/tokens/${L}`;
      await update(ref(db), { [path]: data });
    }

    // ===== アイテム＆ダイス =====
    function renderItemsAndDice(){
      const playing = !!room.started;
      itemsBar.classList.toggle('hide', !playing);
      if(!playing) return;
      itemsBar.innerHTML = '';
      // アイテム群
      (room.items||[]).forEach(it=>{
        const card = el('div',{className:'itemCard'});
        const img = el('img',{alt:"", src: imgPath(it.face==='front'? `item (${it.kind}).jpg` : 'itemback.jpg')});
        card.append(img);
        card.addEventListener('click', ()=>{
          openUseItem(it);
        });
        itemsBar.append(card);
      });
      // ダイス（最後に追加）
      const dice = el('div',{className:'dice'});
      const diImg = el('img',{alt:"", src: imgPath(`di${room.dice||0}.png`)});
      dice.append(diImg);
      dice.addEventListener('click', ()=>{
        const dlg = $('#actionDlg');
        $('#actionTitle').textContent = 'ダイス';
        const body = $('#actionBody');
        body.innerHTML = '';
        const fwd = el('button',{className:'btn',textContent:'進める'});
        const back = el('button',{className:'btn',textContent:'戻す'});
        fwd.onclick = ()=> { update(ref(db, `rooms/${my.code}`), { dice: Math.max(0,(room.dice||0)-1) }); dlg.close(); };
        back.onclick = ()=> { update(ref(db, `rooms/${my.code}`), { dice: Math.min(6,(room.dice||0)+1) }); dlg.close(); };
        body.append(fwd, back);
        $('#actionClose').onclick = ()=> dlg.close();
        dlg.showModal();
      });
      itemsBar.append(dice);
    }

    function openUseItem(it){
      const dlg = $('#actionDlg');
      $('#actionTitle').textContent = `アイテム ${it.kind}`;
      const body = $('#actionBody'); body.innerHTML = '';
      const use = el('button',{className:'btn primary', textContent:'使用する'});
      const flip = el('button',{className:'btn', textContent: (it.face==='front'?'裏にする':'表にする')});
      use.onclick = ()=>{ useItemLogic(it); dlg.close(); };
      flip.onclick = ()=>{ update(ref(db, `rooms/${my.code}/items/${indexOfItem(it.id)}`), { face: it.face==='front'?'back':'front' }); };
      body.append(use, flip);
      $('#actionClose').onclick = ()=> dlg.close();
      dlg.showModal();
    }

    function indexOfItem(id){
      const arr = room.items||[]; for(let i=0;i<arr.length;i++){ if(arr[i].id===id) return i } return -1;
    }

    function chooseLetterPrompt(title, cb){
      const dlg = $('#actionDlg');
      $('#actionTitle').textContent = title;
      const body = $('#actionBody'); body.innerHTML = '';
      const row = el('div',{className:'row'});
      letters.slice(0,15).forEach(L=>{
        const b = el('button',{className:'btn small',textContent:L});
        b.onclick = ()=>{ cb(L); dlg.close(); };
        row.append(b);
      });
      body.append(row);
      $('#actionClose').onclick = ()=> dlg.close();
      dlg.showModal();
    }

    async function useItemLogic(it){
      // 主要実装：
      // 1 (=)：=トークンを最大2つまで付与/更新
      // 12 (≠)：≠トークンを最大2つまで
      // 14 (x1)：x1トークンを最大2つまで
      // 2 （手札交換）：自分→他人のカード1枚ずつ交換（昇順挿入、左寄せ）
      const idx = indexOfItem(it.id);
      if(idx<0) return;
      if(it.kind===1){ // =
        chooseLetterPrompt('＝を置く位置（アルファベット）', async (L)=>{
          // 自席の任意テーブルに置ける仕様だが、ここでは自分の席のテーブルに置く
          const ti = my.seat>=0? my.seat : 0;
          await setToken(ti, L, {type:'eq', value:'='});
        });
        return;
      }
      if(it.kind===12){ // ≠
        chooseLetterPrompt('≠を置く位置（アルファベット）', async (L)=>{
          const ti = my.seat>=0? my.seat : 0;
          await setToken(ti, L, {type:'neq', value:'≠'});
        });
        return;
      }
      if(it.kind===14){ // x1
        chooseLetterPrompt('x1 を置く位置（アルファベット）', async (L)=>{
          const ti = my.seat>=0? my.seat : 0;
          await setToken(ti, L, {type:'x1', value:'x1'});
        });
        return;
      }
      if(it.kind===2){ // 交換
        // 簡易実装：自席のカード a.. を1枚 → 任意テーブルのカード a.. とスワップ
        const tiA = my.seat;
        if(tiA<0){ alert('まず席に座ってください'); return }
        chooseLetterPrompt('自分の交換するカード（アルファベット）', (LA)=>{
          chooseLetterPrompt('相手のカード（アルファベット）', async (LB)=>{
            const tiB = (tiA+1) % (room.tables?.length||1);
            const tA = room.tables[tiA];
            const tB = room.tables[tiB];
            const ia = letters.indexOf(LA); const ib = letters.indexOf(LB);
            if(ia<0||ib<0) return;
            const va = tA.cards[ia]; const vb = tB.cards[ib];
            // 交換
            tA.cards.splice(ia,1); tB.cards.splice(ib,1);
            insertSorted(tA.cards, vb); insertSorted(tB.cards, va);
            // 公開状況リセット
            tA.public = Array(tA.cards.length).fill(null);
            tB.public = Array(tB.cards.length).fill(null);
            const updates = {};
            updates[`rooms/${my.code}/tables/${tiA}/cards`] = tA.cards;
            updates[`rooms/${my.code}/tables/${tiA}/public`] = tA.public;
            updates[`rooms/${my.code}/tables/${tiB}/cards`] = tB.cards;
            updates[`rooms/${my.code}/tables/${tiB}/public`] = tB.public;
            await update(ref(db), updates);
            // ▼マークは簡易にトークンで代用（数秒で消す）
            await setToken(tiA, letters[Math.max(0, tA.cards.indexOf(vb))], {type:'num', value:'▼'});
            await setToken(tiB, letters[Math.max(0, tB.cards.indexOf(va))], {type:'num', value:'▼'});
            setTimeout(async()=>{
              await setToken(tiA, letters[Math.max(0, tA.cards.indexOf(vb))], null);
              await setToken(tiB, letters[Math.max(0, tB.cards.indexOf(va))], null);
            }, 5000);
          });
        });
        return;
      }
    }

    function insertSorted(arr, v){
      // 同値は一番左へ
      let i=0; for(;i<arr.length;i++){ if(v<=arr[i]) break } arr.splice(i,0,v);
    }

    // ===== 設定（席操作・リセット） =====
    const gear = $('#gear'); const gearDlg = $('#gearDlg');
    gear.addEventListener('click', ()=>{
      // 表示制御
      $('#sitBtn').disabled = my.seat>=0 || !room.started;
      $('#leaveSeatBtn').disabled = my.seat<0;
      $('#resetBtn').disabled = !my.host || !room.started;
      $('#resetConfirm').classList.add('hide');
      gearDlg.showModal();
    });
    $('#closeGear').onclick = ()=> gearDlg.close();
    $('#resetBtn').onclick = ()=> $('#resetConfirm').classList.remove('hide');
    $('#cancelReset').onclick = ()=> $('#resetConfirm').classList.add('hide');
    $('#reallyReset').onclick = async()=>{
      if(!my.host) return;
      // ゲーム状態を初期化（参加者は維持）
      await update(ref(db, `rooms/${my.code}`), { started:false, tables:[], seats:[], items:[], dice:0, publicReveals:{} });
      gearDlg.close();
    }

    $('#sitBtn').onclick = ()=>{
      // 座る先を選択（空き席のみ）
      const dlg = $('#actionDlg');
      $('#actionTitle').textContent = '席を選ぶ';
      const body = $('#actionBody'); body.innerHTML = '';
      const row = el('div',{className:'row'});
      (room.seats||[]).forEach((s,i)=>{
        const free = !s?.uid;
        const b = el('button',{className:'btn small', textContent: String(i+1)});
        b.disabled = !free || (!my.host && !free ? true:false);
        b.onclick = async()=>{
          // 既に着席済なら不可
          if(my.seat>=0) return;
          // 他人が座ってたら選べない
          if(!free){ alert('その席は埋まっています'); return }
          const upd = {};
          upd[`rooms/${my.code}/seats/${i}`] = { name: my.name, uid: my.uid, seatedAt: serverTimestamp() };
          await update(ref(db), upd);
          my.seat = i;
          dlg.close(); gearDlg.close();
        }
        row.append(b);
      });
      body.append(row);
      $('#actionClose').onclick = ()=> dlg.close();
      dlg.showModal();
    };

    $('#leaveSeatBtn').onclick = async()=>{
      if(my.seat<0) return;
      const i = my.seat;
      await update(ref(db), { [`rooms/${my.code}/seats/${i}`]: { name:'', uid:'', seatedAt:0 } });
      my.seat = -1; gearDlg.close();
    };

    // ===== ミッション詳細（下部） =====
    const rulesHost = $('#missionRules');
    function renderRules(){
      const parts = [];
      if(room?.mixInfo?.mission===1){
        const x = room.mixInfo.x; parts.push(`**#1 爆弾**\n「xが1つ」\n（今回のx：${x}）`);
      } else {
        parts.push(`**#1 爆弾**\n「xが1つ」`);
      }
      parts.push(`**#2**\n自分の手札の内1枚がランダムに選ばれて、それを手札の一番右側に置く。それ以外は昇順。`);
      if(room?.mixInfo?.mission===3){
        const {xyz, used} = room.mixInfo; parts.push(`**#3 さらい爆弾**\n「x – y - zのうち1つ」\n（候補:${xyz.join(', ')} / 使用:${used}）`)
      } else {
        parts.push(`**#3 さらい爆弾**\n「x – y - zのうち1つ」`);
      }
      rulesHost.innerHTML = parts.map(p=>`<div style="white-space:pre-wrap;margin:8px 0">${p}</div>`).join('');
    }
    setInterval(()=>{ if(room) renderRules(); }, 1500);

    // ===== 起動時ヘルパ =====
    // コード入力のエコー
    codeInput.addEventListener('input', ()=>{ codeEcho.textContent = codeInput.value.trim(); });

  </script>
</body>
</html>
