<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BOMB BUSTERS</title>
  <style>
    :root {
      --bg: #fff;
      --ink: #111;
      --muted: #666;
      --accent: #111;
      --card-bg: #eaeaea;
      --card-ink: #fff;
      --public-bg: #111;
      --public-ink: #fff;
      --token-bg: #111;
      --token-ink: #fff;
      --chip: 8px;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, Arial, sans-serif;}
    .container{max-width:560px;margin:0 auto;padding:12px 12px 80px;}
    h1{font-size:22px;letter-spacing:1px;margin:8px 0 12px;text-align:center}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="text"]{flex:1;min-width:140px;padding:10px 12px;border:1px solid #ddd;border-radius:12px;font-size:16px}
    button{appearance:none;border:1px solid #111;background:#111;color:#fff;padding:10px 12px;border-radius:12px;font-weight:700;font-size:14px}
    button.ghost{background:#fff;color:#111}
    button.small{padding:6px 10px;border-radius:10px;font-size:12px}
    .pill{border-radius:999px;border:1px solid #111;padding:6px 10px;display:inline-flex;gap:6px;align-items:center}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .tabs{display:flex;gap:6px;overflow:auto;padding-bottom:2px}
    .tabs::-webkit-scrollbar{height:6px}
    .hint{color:var(--muted);font-size:12px}
    .divider{height:1px;background:#eee;margin:12px 0}

    .lobby-list{position:sticky;bottom:0;background:linear-gradient(180deg, rgba(255,255,255,.92), #fff 60%);backdrop-filter: blur(4px);border-top:1px solid #eee;padding:8px 12px;}
    .lobby-list h3{margin:0 0 6px;font-size:13px;color:#444}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px;margin:3px 3px 0 0}

    .tables{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .table{border:1px solid #ddd;border-radius:16px;padding:8px;min-height:90px;position:relative;overflow:hidden}
    .seatBadge{position:absolute;left:8px;top:6px;font-size:12px;color:#333;text-decoration:underline;}
    .seatName{position:absolute;left:8px;top:6px;font-size:12px;color:#333;text-decoration:underline;}
    .charcard{position:absolute;left:8px;top:24px;width:40px;height:60px;border-radius:8px;overflow:hidden;border:1px solid #ddd;background:#f6f6f6;display:grid;place-items:center}
    .charcard img{width:100%;height:100%;object-fit:cover;display:block}

    .handArea{position:absolute;left:60px;right:8px;top:6px;height:90px;display:flex;flex-direction:column;justify-content:center}
    .cards{display:flex;align-items:center;gap:3px;max-width:100%;overflow:auto}
    .card{width:24px;height:50px;border-radius:6px;border:1px solid #ccc;background:var(--card-bg);position:relative;flex:0 0 auto}
    .card .num{position:absolute;left:0;right:0;top:2px;text-align:center;font-size:16px;line-height:1;color:var(--card-ink);font-weight:700;}
    .card.public{background:var(--public-bg);border-color:#000}
    .card.public .num{color:var(--public-ink)}
    .card .band{position:absolute;left:0;right:0;bottom:0;height:16px;background-position:center bottom;background-repeat:no-repeat;background-size:contain}
    .band.normal{background-image:url('./assets/codenumber.png');}
    .band.red{background-image:url('./assets/redcode.png');}
    .band.yellow{background-image:url('./assets/yellowcode.png');}
    .card.back{background:#ccc url('./assets/codeback.png') center/cover no-repeat}

    .alphaRow{display:flex;gap:3px;margin-top:4px}
    .alpha{width:24px;text-align:center;font-size:10px;border:1px solid #ddd;border-radius:6px;padding:2px 0;background:#fff}
    .token{margin-top:2px;width:24px;text-align:center;font-size:10px;border:1px solid #000;border-radius:6px;padding:2px 0;background:var(--token-bg);color:var(--token-ink)}

    .gear{position:fixed;right:12px;bottom:12px;width:48px;height:48px;border-radius:16px;border:1px solid #111;background:#111;color:#fff;display:grid;place-items:center;font-size:22px}
    .menu{position:fixed;right:12px;bottom:72px;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:8px;display:none;min-width:180px}
    .menu.show{display:block}
    .menu button{width:100%;text-align:left;margin:4px 0}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.12);display:none}
    .overlay.show{display:block}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:12px;min-width:240px;display:none}
    .modal.show{display:block}

    .foot-space{height:80px}
  </style>
</head>
<body>
  <div class="container">
    <h1>BOMB&nbsp;BUSTERS</h1>

    <!-- Top controls -->
    <div class="row">
      <input id="codeInput" type="text" inputmode="numeric" maxlength="4" placeholder="ルームコード(4桁)" />
      <button id="joinBtn">入室</button>
      <button id="makeBtn" class="ghost">コード作成</button>
    </div>

    <div class="controls">
      <span class="pill" id="youTag">あなた: <b id="yourName">---</b></span>
      <span class="pill">人数:
        <button class="small" data-p="4">4</button>
        <button class="small" data-p="5">5</button>
      </span>
      <span class="pill">ミッション:
        <button class="small" data-m="1">#1</button>
        <button class="small" data-m="2">#2</button>
        <button class="small" data-m="3">#3</button>
        <button class="small" data-m="4">#4</button>
        <button class="small" data-m="5">#5</button>
      </span>
      <button id="startBtn">爆弾を解除！</button>
    </div>
    <div class="hint">※「爆弾を解除！」は最初に部屋を建てた人（ホスト）だけ押せます。ゲーム開始前は下部に入室者リストが見えます。</div>

    <div class="divider"></div>

    <div id="tables" class="tables" aria-live="polite"></div>

    <div class="foot-space"></div>
  </div>

  <!-- sticky lobby list -->
  <div id="lobby" class="lobby-list" hidden>
    <h3>入室者</h3>
    <div id="lobbyChips"></div>
  </div>

  <!-- gear & menus -->
  <button id="gear" class="gear" title="設定">⚙️</button>
  <div id="menu" class="menu" role="menu">
    <button id="sitBtn">席に座る</button>
    <button id="leaveSeatBtn">席を立つ</button>
    <button id="retryBtn">やり直し</button>
  </div>

  <!-- overlays -->
  <div id="overlay" class="overlay"></div>
  <div id="modal" class="modal"></div>

  <script>
  // =========================
  // Firebase setup
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyBpSx_lEcg1j9ExMJsVl5lBqAxOCfmFmSnI",
    authDomain: "chat-68c4c.firebaseapp.com",
    databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
    projectId: "chat-68c4c",
    storageBucket: "chat-68c4c.appspot.com",
    messagingSenderId: "172284325975",
    appId: "1:172284325975:web:6f9bdd77e822c0ea39dd92"
  };
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  // =========================
  // Utilities & State
  // =========================
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const $ = (q) => document.querySelector(q);
  const $$ = (q) => Array.from(document.querySelectorAll(q));

  const randHiraganaName = () => {
    const hira = "あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん";
    let s = "";
    for (let i=0;i<3;i++) s += hira[Math.floor(Math.random()*hira.length)];
    return s;
  };

  const uid = (()=> Math.random().toString(36).slice(2)+Date.now().toString(36))();
  let yourName = localStorage.getItem('bb_name') || randHiraganaName();
  localStorage.setItem('bb_name', yourName);
  $('#yourName').textContent = yourName;

  let roomCode = null;     // 4 digits
  let isHost = false;      // first creator
  let unsubRoom = null;    // off listener fn
  let currentRoomSnap = null;
  let seatedTable = null;  // index
  let playing = false;

  const asNum = (v)=> Number(v||0);

  // =========================
  // Realtime paths
  // =========================
  const rRef = ()=> db.ref('rooms/'+roomCode);
  const playersRef = ()=> db.ref('rooms/'+roomCode+'/players');
  const stateRef = ()=> db.ref('rooms/'+roomCode+'/state');
  const settingsRef = ()=> db.ref('rooms/'+roomCode+'/settings');
  const tablesRef = ()=> db.ref('rooms/'+roomCode+'/tables');

  // =========================
  // Room create / join
  // =========================
  const genCode = () => (''+Math.floor(1000+Math.random()*9000));

  const ensureRoom = async(code) => {
    const ref = db.ref('rooms/'+code);
    const snap = await ref.get();
    if (!snap.exists()) {
      const now = firebase.database.ServerValue.TIMESTAMP;
      isHost = true;
      await ref.set({
        createdAt: now,
        hostId: uid,
        playerCount: 0,
        state: { status: 'lobby', startedAt: 0 },
        settings: { players: 4, mission: 1 },
        tables: []
      });
    } else {
      const data = snap.val();
      isHost = data.hostId === uid; // usually false when joining
    }
    return ref;
  };

  const joinRoom = async(code) => {
    roomCode = code;
    const ref = await ensureRoom(code);

    // presence entry
    const pRef = playersRef().child(uid);
    const now = firebase.database.ServerValue.TIMESTAMP;
    const player = { name: yourName, seatedTable: null, isHost: isHost, online: true, lastSeen: now };
    await pRef.set(player);

    // playerCount ++
    await rRef().child('playerCount').transaction(n => (asNum(n)+1));

    // onDisconnect clean player & decrement
    pRef.onDisconnect().remove();
    rRef().child('playerCount').onDisconnect().transaction(n => Math.max(0, asNum(n)-1));

    // listener
    if (unsubRoom) unsubRoom();
    unsubRoom = rRef().on('value', (snap)=>{
      currentRoomSnap = snap;
      renderRoom(snap.val());
    });

    // show lobby until playing
    $('#lobby').hidden = false;
  };

  const leaveRoom = async() => {
    if (!roomCode) return;
    try {
      await playersRef().child(uid).remove();
      await rRef().child('playerCount').transaction(n => Math.max(0, asNum(n)-1));
    } catch(e){}
  };

  window.addEventListener('beforeunload', leaveRoom);

  // =========================
  // Settings actions
  // =========================
  const setPlayers = (p)=> settingsRef().update({ players: p });
  const setMission = (m)=> settingsRef().update({ mission: m });

  const startGame = async()=>{
    if (!isHost) return alert('ホストだけ開始できます');
    const room = (await rRef().get()).val();

    // tables by selected players
    const P = room.settings?.players || 4;
    const tables = Array.from({length:P}, (_,i)=>({
      name: '_'+(i+1), // will underline via CSS – placeholder; replaced by player name when seated
      playerId: null,
      character: { img: null, face: 'front' },
      hand: { cards: [], public: {} }, // public[index]=true if revealed globally
      tokens: {} // index -> number
    }));

    // assign character images: one table gets member(5), others shuffled 1..4
    const idxCaptain = Math.floor(Math.random()*P); // 隊長（表示しない）
    const others = [1,2,3,4].sort(()=>Math.random()-0.5);
    let oi = 0;
    for (let i=0;i<P;i++){
      if (i===idxCaptain){
        tables[i].character.img = './assets/member (5).jpg';
      } else {
        tables[i].character.img = `./assets/member (${others[oi%4]}).jpg`;
        oi++;
      }
    }

    // build deck 1..12 (x4) => 48
    const deck=[]; for(let n=1;n<=12;n++){ for(let k=0;k<4;k++) deck.push({value:n,type:'normal'}); }
    deck.sort(()=>Math.random()-0.5);

    // Deal round-robin to seated players later; initially hands empty; once players sit, they will be bound to a table and see their hand
    // But spec: "参加者にできるだけ一枚ずつ漏らすことなく配布" ⇒ distribute immediately to tables count
    for (let i=0;i<deck.length;i++){
      const t = i % P;
      tables[t].hand.cards.push(deck[i]);
    }

    await rRef().update({
      state: { status: 'playing', startedAt: firebase.database.ServerValue.TIMESTAMP, captain: idxCaptain },
      tables
    });
  };

  const retryGame = async()=>{
    if (!isHost) return;
    // Confirm UI
    tinyConfirm('やり直しますか？',{okLabel:'やり直す', cancelLabel:'キャンセル', okClass:'small'}, async(ok)=>{
      if (!ok) return;
      // Everyone who is currently joined becomes participant again; reset state to lobby
      await rRef().update({ state: { status:'lobby', startedAt: 0 }, tables: [] });
      // seated flags cleared
      const ps = (await playersRef().get()).val()||{};
      const updates={};
      Object.keys(ps).forEach(id=> updates[id+'/seatedTable']=null );
      await playersRef().update(updates);
      alert('ルームをリセットしました。');
    });
  };

  // =========================
  // Render
  // =========================
  function renderRoom(room){
    if(!room) return;
    playing = room.state?.status === 'playing';

    // host only start visible
    $('#startBtn').disabled = !isHost;
    $('#startBtn').style.opacity = isHost?1:.6;

    // lobby list
    const players = room.players||{};
    const chips = Object.entries(players).map(([id,p])=>{
      const taken = p.seatedTable!=null ? ` / 着席: ${asNum(p.seatedTable)+1}`:'';
      const host = p.isHost? '👑':'';
      return `<span class="chip">${host}${escapeHtml(p.name)}${taken}</span>`;
    }).join('');
    $('#lobbyChips').innerHTML = chips || '<span class="hint">（まだ誰もいません）</span>';
    $('#lobby').hidden = playing; // ゲーム開始後は非表示

    // settings reflection
    document.querySelectorAll('[data-p]').forEach(btn=>{
      const p = Number(btn.getAttribute('data-p'));
      btn.style.background = (room.settings?.players===p?'#111':'#fff');
      btn.style.color = (room.settings?.players===p?'#fff':'#111');
      btn.onclick = ()=> isHost && setPlayers(p);
    });
    document.querySelectorAll('[data-m]').forEach(btn=>{
      const m = Number(btn.getAttribute('data-m'));
      btn.style.background = (room.settings?.mission===m?'#111':'#fff');
      btn.style.color = (room.settings?.mission===m?'#fff':'#111');
      btn.onclick = ()=> isHost && setMission(m);
    });

    // render tables vertical
    const wrap = $('#tables');
    wrap.innerHTML = '';
    const tables = room.tables || [];
    tables.forEach((t,idx)=>{
      const div = document.createElement('div');
      div.className = 'table';

      const seatLabel = (t.playerId && players[t.playerId]) ? `<span class="seatName">${escapeHtml(players[t.playerId].name)}</span>` : `<span class="seatBadge">_${idx+1}</span>`;
      div.insertAdjacentHTML('afterbegin', seatLabel);

      // character card
      const char = document.createElement('div');
      char.className = 'charcard';
      char.onclick = ()=>{
        // anyone can flip character; flipping replaces image (overwrite, not add)
        const face = (t.character?.face==='front')?'back':'front';
        tablesRef().child(idx+'/character/face').set(face);
      };
      const img = document.createElement('img');
      if (t.character?.face === 'back') {
        img.src = './assets/battery.jpg';
      } else {
        img.src = t.character?.img || '';
      }
      char.replaceChildren(img); // overwrite image strictly
      div.appendChild(char);

      // hand area
      const handArea = document.createElement('div');
      handArea.className = 'handArea';

      const cardsRow = document.createElement('div');
      cardsRow.className = 'cards';

      const isYourSeat = (seatedTable===idx);

      const cards = (t.hand?.cards||[]);
      const pub = (t.hand?.public||{});

      cards.forEach((card, ci)=>{
        const c = document.createElement('div');
        c.className = 'card';

        const revealedPublic = !!pub[ci];

        // your own hand shows face (toggle allowed); others are back unless public
        const faceUpForYou = isYourSeat;
        const showFront = revealedPublic || faceUpForYou;

        if (!showFront) {
          c.classList.add('back');
        } else {
          if (revealedPublic) c.classList.add('public');
          const num = document.createElement('div');
          num.className = 'num';
          num.textContent = String(card.value);
          const band = document.createElement('div');
          band.className = 'band ' + (card.type||'normal');
          c.appendChild(num);
          c.appendChild(band);
        }

        // click behavior
        c.onclick = ()=>{
          if (isYourSeat) {
            // toggle own card front/back (local intent = public? keep public visible)
            // If already public, nothing to toggle (still shown)
            if (revealedPublic) return;
            // we simulate local visibility by toggling seat to re-render; but requirement: 自分だけが表を見れる ⇒ already handled by isYourSeat
            // nothing to write to DB for private flip
          } else {
            // reveal publicly (anyone can click)
            const updates = {}; updates[ci] = true;
            tablesRef().child(idx+'/hand/public').update(updates);
          }
        };

        cardsRow.appendChild(c);
      });

      const alphaRow = document.createElement('div');
      alphaRow.className = 'alphaRow';
      const tokenRow = document.createElement('div');
      tokenRow.className = 'alphaRow';

      for (let i=0;i<cards.length;i++){
        const a = document.createElement('div');
        a.className = 'alpha';
        a.textContent = String.fromCharCode(97+i); // a,b,c...
        a.title = '情報トークン';
        if (isYourSeat) {
          a.style.cursor = 'pointer';
          a.onclick = ()=>{
            const num = cards[i]?.value;
            if (num==null) return;
            tinyConfirm(`「${String.fromCharCode(97+i)}」の下に ${num} を公開しますか？`, {okLabel:'公開', cancelLabel:'やめる'}, (ok)=>{
              if (!ok) return;
              const up={}; up[i]=num;
              tablesRef().child(idx+'/tokens').update(up);
            });
          };
        }
        alphaRow.appendChild(a);

        const token = document.createElement('div');
        token.className = 'token';
        const tv = (t.tokens||{})[i];
        token.textContent = (tv==null)?'':tv;
        tokenRow.appendChild(token);
      }

      handArea.appendChild(cardsRow);
      handArea.appendChild(alphaRow);
      handArea.appendChild(tokenRow);

      div.appendChild(handArea);

      wrap.appendChild(div);
    });
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  }

  // =========================
  // Gear menu & seat logic
  // =========================
  const gear = $('#gear');
  const menu = $('#menu');
  const overlay = $('#overlay');
  const modal = $('#modal');

  gear.onclick = ()=> menu.classList.toggle('show');
  overlay.onclick = ()=>{ overlay.classList.remove('show'); modal.classList.remove('show'); };

  $('#sitBtn').onclick = async()=>{
    if (!currentRoomSnap) return;
    const room = currentRoomSnap.val();
    if (room.state?.status !== 'playing') return alert('ゲーム開始後に席を選べます');
    // choose a free table
    const tables = room.tables||[];
    const players = room.players||{};

    const taken = new Set(Object.values(players).filter(p=>p.seatedTable!=null).map(p=>p.seatedTable));
    const choices = tables.map((_,i)=>({i, free:!taken.has(i)}));

    const list = choices.map(c=> `<button class="small" data-i="${c.i}" ${c.free?'':'disabled'}>テーブル ${c.i+1} ${c.free?'':'（使用中）'}</button>`).join(' ');
    tinyPanel('席を選択', `<div class="tabs">${list}</div>`, (root)=>{
      root.querySelectorAll('button[data-i]').forEach(btn=>{
        btn.onclick = async()=>{
          const idx = Number(btn.getAttribute('data-i'));
          if (!choices[idx].free) return;
          // set seat if free (prevent racing)
          const ok = await playersRef().transaction(cur=>{
            cur = cur||{};
            const ids = Object.keys(cur);
            // is someone already seated at idx?
            const used = ids.some(id=> cur[id]?.seatedTable===idx);
            if (used) return cur; // no-op
            if (!cur[uid]) cur[uid]={name:yourName, online:true};
            cur[uid].seatedTable = idx;
            return cur;
          });
          overlay.classList.remove('show'); modal.classList.remove('show');
          menu.classList.remove('show');
          seatedTable = idx;
        };
      });
    });
  };

  $('#leaveSeatBtn').onclick = async()=>{
    const pRef = playersRef().child(uid);
    const pSnap = await pRef.get();
    const p = pSnap.val();
    if (!p || p.seatedTable==null) return;
    await pRef.update({ seatedTable: null });
    seatedTable = null;
    menu.classList.remove('show');
  };

  $('#retryBtn').onclick = ()=> retryGame();

  // =========================
  // Tiny modal helpers
  // =========================
  function tinyPanel(title, html, onMount){
    overlay.classList.add('show');
    modal.classList.add('show');
    modal.innerHTML = `
      <div style="font-weight:700;margin-bottom:8px">${title}</div>
      <div>${html}</div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="ghost" id="closeM">閉じる</button>
      </div>
    `;
    $('#closeM').onclick = ()=>{ overlay.classList.remove('show'); modal.classList.remove('show'); };
    if (onMount) onMount(modal);
  }
  function tinyConfirm(msg, opts, cb){
    opts = Object.assign({okLabel:'OK', cancelLabel:'キャンセル', okClass:''}, opts||{});
    overlay.classList.add('show');
    modal.classList.add('show');
    modal.innerHTML = `
      <div style="margin-bottom:8px">${msg}</div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="ghost" id="cancelM">${opts.cancelLabel}</button>
        <button class="${opts.okClass}" id="okM">${opts.okLabel}</button>
      </div>
    `;
    $('#cancelM').onclick = ()=>{ overlay.classList.remove('show'); modal.classList.remove('show'); cb(false); };
    $('#okM').onclick = ()=>{ overlay.classList.remove('show'); modal.classList.remove('show'); cb(true); };
  }

  // =========================
  // Top controls handlers
  // =========================
  $('#makeBtn').onclick = ()=>{
    const code = genCode();
    $('#codeInput').value = code;
  };

  $('#joinBtn').onclick = async()=>{
    const code = ($('#codeInput').value||'').replace(/\D/g,'').slice(0,4);
    if (code.length!==4) return alert('4桁のコードを入れてください');
    await joinRoom(code);
  };

  $('#startBtn').onclick = ()=> startGame();

  // expose name pill click to re-roll name (optional)
  $('#youTag').onclick = ()=>{
    tinyConfirm('ランダムな名前（ひらがな3文字）を再生成しますか？',{okLabel:'変える', cancelLabel:'やめる'}, (ok)=>{
      if (!ok) return;
      yourName = randHiraganaName();
      localStorage.setItem('bb_name', yourName);
      $('#yourName').textContent = yourName;
      if (roomCode) playersRef().child(uid).update({name: yourName});
    });
  };

  </script>
</body>
</html>
